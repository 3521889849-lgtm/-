1）排班表显示“在线状态”（更生动：绿色小格/圆点）
1.1 在线状态判定规则（必须按此实现）

在线状态与排班“是否在上班”不是一回事，但我这里要做成强关联：

客服登录系统 => 视为在线（上班中）

客服退出/掉线 => 视为离线（未上班）

同时要考虑排班时间窗口：

若客服 登录，且当前时间在该客服当日当前班次时间段内 → 显示「🟢在线」

若客服 登录，但不在当前排班时间段 → 显示「🟡在线但未到班/非班次」

若客服 未登录，但处于排班时间段 → 显示「🔴应在岗但离线（异常）」

若客服 未登录，且不在排班时间段 → 显示「⚪离线」

前端排班表的小方格/小圆点要根据上述状态动态变色，并带 hover 提示（例如：最后心跳时间、登录时间、当前班次）。

1.2 技术实现建议（后端必须支持）

建议新增 cs_presence（在线状态表/缓存）或直接用 Redis：

presence:{cs_id} => {is_online, last_seen_at, login_at, device, ip}

心跳机制（WebSocket/HTTP ping 均可）：

登录成功写入 online

每 30s 更新 last_seen

超过 90s 无心跳 => 视为离线

退出登录立刻置离线

2）请假申请：支持“从哪天到哪天”，且每天可选上午/下午
2.1 请假数据结构（必须支持半天）

请假范围：

start_date

start_half：AM/PM

end_date

end_half：AM/PM

额外字段：

leave_type（事假/病假/年假…）

reason

attachments（可选）

status：PENDING / APPROVED / REJECTED / CANCELED

approver_role、approver_id、approved_at

approve_comment（批注必须落库）

审批链路记录：必须能追溯“谁在什么时候批注/审批了什么”

2.2 请假对排班影响（你要实现）

请假审批通过后：

影响对应日期范围内的排班，排班格子显示「请假标记」并不可派单（或提示异常）

若请假与已排班冲突：

申请阶段提示“与排班冲突”，但仍允许提交（由审批人决定）

审批通过后：自动将对应排班置为 LEAVE 或 UNAVAILABLE 状态

3）角色扩展：管理员 / 客服 / 部门经理（审批权限、页面权限）
3.1 RBAC 权限矩阵（必须实现）

客服（CS）：

可：提交请假申请、提交调班申请、查看自己的排班/申请记录

不可：审批他人申请

部门经理（Manager）：

可：审批本部门客服的请假/调班（必须记录审批人+批注）

可：查看本部门排班与申请列表

不需要“发起请假/调班申请页面”（只保留审批处理）

管理员（Admin）：

可：配置班次、排班、查看所有部门数据、兜底审批/二级审批（可选）

不需要“发起请假申请页面”（只保留审批处理 + 管理功能）

注意：审批范围要受“部门”约束：Manager 只能审批自己部门的客服；Admin 不受限制。

3.2 数据模型必须具备部门归属

user.department_id

manager.department_id 或通过用户表角色关联

4）管理员/经理登录后：不显示“请假申请入口”，只保留“审批处理入口”

前端路由与菜单要做权限控制：

CS 菜单：排班表 / 请假申请 / 调班申请 / 我的申请、客服回话

Manager 菜单：排班总览 / 审批中心（请假审批、调班审批）/ 审批记录

Admin 菜单：排班配置 / 排班管理 / 审批中心 / 人员管理 / 部门管理、客服回话 记录、人员分配权限管理（权限管理）
5）调班申请：必须显示“对方班次”，并处理多人互换的冲突
5.1 调班申请交互要求（前端）

调班申请页面必须清晰展示：

我是谁（申请人）

我要换的班次（我当前班次：日期 + shift）

我希望换到谁（目标客服）

对方当前班次是什么（日期 + shift + 状态）

如果是“三人调班/链式调班”：

用可视化链路展示：A → B → C → A（或 A→B→C）

每一步都显示该人的目标班次

5.2 调班数据结构（后端必须能表达多方）

方案 A（推荐）：swap_request + swap_request_items

swap_request：申请单主表（状态、申请人、部门、原因、审批信息）

swap_request_items：链路明细（第几步、cs_id、from_schedule_id、to_schedule_id）

必须有字段记录：

status：PENDING/APPROVED/REJECTED/CANCELED

approver_id / approved_at / approve_comment

conflict_flag、conflict_reason

5.3 冲突检测（必须实现，避免三人互换出现抢占）

常见冲突：

目标班次在审批中被其他申请锁定

对方班次已被调整/请假占用

三人链路中任意一步无效导致整体不可执行

要求：

提交申请时先做一次“预校验”

审批通过执行时必须做“二次校验 + 事务/分布式锁”

通过后原子性地更新所有相关 schedule 记录（要么全部成功，要么全部失败回滚）

6）接口清单（请按 REST 或 RPC 生成，含字段与示例）

你需要输出以下接口设计（含请求/响应结构、状态码、错误码）：

6.1 在线状态

POST /auth/login（写入 online + login_at）

POST /auth/logout（置 offline）

POST /presence/heartbeat

GET /presence/list?date=YYYY-MM-DD（排班表批量拿在线状态）

GET /schedule/list?start=...&end=...（排班 + 在线状态合并返回）

6.2 请假

POST /leave/apply

GET /leave/mine

GET /leave/pending（审批列表，Manager/Admin）

POST /leave/approve

POST /leave/reject

GET /leave/audit-log?leave_id=...

6.3 调班

POST /swap/apply（支持链式 items）

GET /swap/mine

GET /swap/pending

POST /swap/approve

POST /swap/reject

GET /swap/preview-conflict?payload=...（可选，用于前端实时提示）