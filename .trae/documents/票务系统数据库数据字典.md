# 票务系统数据库数据字典

本文档描述了票务系统商家入驻及相关模块的数据库表结构设计。

## 1. 商家入驻模块 (Merchant Settlement)

### 1.1 商家入驻申请表 (merchant_settlement_applies)
存储商家的入驻申请核心信息，包括主体信息、联系人信息及业务概况。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 入驻申请记录主键ID | 主键, 自增 |
| apply_no | VARCHAR(32) | 是 | 入驻申请编号（幂等键） | 唯一索引 |
| merchant_name | VARCHAR(128) | 是 | 商家名称 | 索引 |
| unified_social_credit_code | VARCHAR(18) | 是 | 统一社会信用代码 | 唯一索引 |
| register_address | VARCHAR(255) | 是 | 注册地址 | |
| business_address | VARCHAR(255) | 是 | 经营地址 | |
| contact_person | VARCHAR(32) | 是 | 联系人 | |
| contact_phone | VARCHAR(16) | 是 | 联系电话 | |
| contact_email | VARCHAR(64) | 否 | 联系邮箱 | |
| ticket_types | VARCHAR(64) | 是 | 票务类型（枚举拼接） | 索引 |
| main_business | VARCHAR(128) | 是 | 主营票务品类 | |
| coverage_area | VARCHAR(128) | 是 | 覆盖区域 | |
| cooperation_channels | VARCHAR(255) | 否 | 合作票务渠道 | |
| estimated_annual_turnover | DECIMAL(18,2) | 否 | 年营业额预估（单位：元） | |
| apply_status | TINYINT | 是 | 入驻申请状态 | 0-草稿 1-待审核 2-审核中 3-审核通过 4-驳回 5-已撤销 |
| draft_flag | TINYINT | 是 | 是否草稿 | 0-非草稿 1-草稿, 默认1 |
| apply_time | DATETIME | 是 | 申请提交时间 | 索引 |
| last_modify_time | DATETIME | 是 | 最后修改时间 | |
| wechat_openid | VARCHAR(64) | 否 | 微信快捷登录标识 | |
| ctrip_user_id | BIGINT UNSIGNED | 否 | 携程用户ID | 兼容现有体系 |
| remark | VARCHAR(512) | 否 | 商家备注 | |
| creator | VARCHAR(32) | 是 | 创建人（登录账号） | |
| created_at | DATETIME | 是 | 记录创建时间 | 默认当前时间 |
| updated_at | DATETIME | 是 | 记录更新时间 | 更新时自动更新 |
| deleted_at | DATETIME | 否 | 软删除时间 | 索引 |

### 1.2 商家资质信息表 (merchant_qualifications)
存储商家上传的各类资质文件及校验结果。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 资质记录主键ID | 主键, 自增 |
| apply_id | BIGINT UNSIGNED | 是 | 关联入驻申请ID | 索引 |
| qualification_type | TINYINT | 是 | 资质类型 | 1-营业执照 2-票务经营许可证 3-法人身份证 4-场地使用证明 5-安全经营承诺书 |
| file_name | VARCHAR(128) | 是 | 资质文件名称 | |
| file_oss_path | VARCHAR(255) | 是 | OSS存储路径 | |
| file_size | BIGINT UNSIGNED | 是 | 文件大小（单位：字节） | |
| file_md5 | VARCHAR(32) | 是 | 文件MD5值 | 唯一索引, 防重复上传 |
| certificate_no | VARCHAR(64) | 否 | 证件编号 | |
| issue_date | DATE | 否 | 发证日期 | |
| expire_date | DATE | 是 | 过期日期 | 索引 |
| is_valid | TINYINT | 是 | 资质是否有效 | 0-无效 1-有效, 默认0 |
| verify_result | TINYINT | 是 | 自动校验结果 | 0-未校验 1-校验通过 2-校验失败, 默认0 |
| verify_remark | VARCHAR(512) | 否 | 校验备注 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 1.3 电子合同表 (merchant_electronic_contracts)
管理商家入驻过程中的电子合同签署记录。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 合同记录主键ID | 主键, 自增 |
| apply_id | BIGINT UNSIGNED | 是 | 关联入驻申请ID | 唯一索引 |
| contract_no | VARCHAR(32) | 是 | 合同编号 | 唯一索引 |
| contract_name | VARCHAR(128) | 是 | 合同名称 | |
| contract_template_id | VARCHAR(32) | 是 | 合同模板ID | |
| contract_oss_path | VARCHAR(255) | 是 | 合同OSS存储路径 | |
| sign_status | TINYINT | 是 | 签署状态 | 0-未生成 1-待签署 2-已签署 3-签署失效 |
| merchant_sign_time | DATETIME | 否 | 商家签署时间 | |
| platform_sign_time | DATETIME | 否 | 平台签署时间 | |
| sign_certificate | VARCHAR(255) | 否 | 签署凭证 | 法律效力证明 |
| expire_date | DATE | 否 | 合同过期日期 | |
| created_at | DATETIME | 是 | 合同生成时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 1.4 入驻通知记录表 (merchant_notifications)
记录系统发送给商家的各类通知消息。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 通知记录主键ID | 主键, 自增 |
| apply_id | BIGINT UNSIGNED | 是 | 关联入驻申请ID | 索引 |
| notification_type | TINYINT | 是 | 通知类型 | 1-申请提交成功 2-资质审核通过 3-资质审核驳回 4-合同待签署 5-店铺开通 |
| notify_channel | TINYINT | 是 | 通知渠道 | 1-短信 2-站内信 3-邮件 |
| notify_content | VARCHAR(512) | 是 | 通知内容 | |
| receiver | VARCHAR(64) | 是 | 接收人 | 手机号/邮箱/用户名 |
| send_status | TINYINT | 是 | 发送状态 | 0-待发送 1-发送成功 2-发送失败 |
| send_time | DATETIME | 否 | 发送时间 | |
| retry_count | TINYINT | 是 | 重试次数 | 最大3次, 默认0 |
| read_status | TINYINT | 是 | 已读状态 | 0-未读 1-已读, 默认0 |
| read_time | DATETIME | 否 | 已读时间 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

## 2. 商家管理模块 (Merchant Management)

### 2.1 商家店铺配置表 (merchant_shop_configs)
入驻成功后的店铺基础配置信息。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 店铺配置主键ID | 主键, 自增 |
| merchant_id | BIGINT UNSIGNED | 是 | 商家唯一标识 | 唯一索引 |
| apply_id | BIGINT UNSIGNED | 是 | 关联入驻申请ID | 索引 |
| shop_name | VARCHAR(128) | 是 | 店铺名称 | |
| shop_logo_oss_path | VARCHAR(255) | 否 | 店铺logo OSS路径 | |
| ticket_category_ids | VARCHAR(64) | 是 | 开通票务类目ID | 逗号分隔 |
| business_status | TINYINT | 是 | 店铺经营状态 | 0-未开通 1-正常运营 2-暂停运营 3-注销 |
| permission_config | JSON | 否 | 权限配置 | |
| operator_id | VARCHAR(32) | 是 | 配置操作员ID | |
| created_at | DATETIME | 是 | 店铺创建时间 | |
| updated_at | DATETIME | 是 | 配置更新时间 | |

### 2.2 商家店铺扩展配置表 (merchant_shop_ext_configs)
店铺的扩展信息。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 扩展配置主键ID | 主键, 自增 |
| merchant_id | VARCHAR(32) | 是 | 商家ID | 唯一索引 |
| shop_name | VARCHAR(128) | 是 | 店铺名称 | |
| shop_logo_url | VARCHAR(255) | 否 | 店铺logo URL | |
| business_address | VARCHAR(255) | 是 | 经营地址 | |
| contact_phone | VARCHAR(16) | 是 | 联系电话 | |
| business_hours | VARCHAR(128) | 否 | 营业时间 | |
| description | VARCHAR(512) | 否 | 店铺描述 | |
| status | TINYINT | 是 | 店铺状态 | 0-停用 1-正常, 默认1 |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 2.3 商家票务类目申请表 (merchant_ticket_categories)
商家申请开通的票务类目记录。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 类目申请主键ID | 主键, 自增 |
| merchant_id | VARCHAR(32) | 是 | 商家ID | 索引 |
| category_id | INT UNSIGNED | 是 | 票务类目ID | 索引 |
| category_name | VARCHAR(64) | 是 | 类目名称 | |
| apply_reason | VARCHAR(512) | 否 | 申请理由 | |
| status | TINYINT | 是 | 开通状态 | 0-未开通 1-已开通 2-审核中 3-已拒绝, 默认0 |
| apply_time | DATETIME | 是 | 申请时间 | |
| approve_time | DATETIME | 否 | 审批时间 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 2.4 商家用户角色表 (merchant_user_roles)
商家体系下的用户角色分配。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 用户角色主键ID | 主键, 自增 |
| merchant_id | VARCHAR(32) | 是 | 商家ID | 索引 |
| user_id | VARCHAR(32) | 是 | 用户ID | 索引 |
| user_name | VARCHAR(64) | 是 | 用户姓名 | |
| role_codes | VARCHAR(255) | 是 | 角色代码列表 | 逗号分隔 |
| role_names | VARCHAR(255) | 是 | 角色名称列表 | 逗号分隔 |
| permissions | TEXT | 否 | 权限代码列表 | 逗号分隔 |
| assigned_at | DATETIME | 是 | 分配时间 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

## 3. 审核流程模块 (Audit Flow)

### 3.1 审核流程表 (merchant_audit_flows)
记录具体的入驻申请审核过程和结果。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 审核流程主键ID | 主键, 自增 |
| apply_id | BIGINT UNSIGNED | 是 | 关联入驻申请ID | 索引 |
| audit_no | VARCHAR(32) | 是 | 审核单号 | 唯一索引 |
| ticket_type | TINYINT | 是 | 票务类型 | 匹配审核链路, 索引 |
| audit_node | TINYINT | 是 | 审核节点 | 1-自动审核 2-业务线初审 3-合规复审 4-终审 |
| audit_type | TINYINT | 是 | 审核类型 | 1-自动审核 2-人工审核 |
| auditor_id | VARCHAR(32) | 否 | 审核人ID | |
| auditor_name | VARCHAR(32) | 否 | 审核人姓名 | |
| audit_status | TINYINT | 是 | 审核状态 | 0-待审核 1-审核中 2-审核通过 3-驳回 |
| audit_opinion | VARCHAR(512) | 否 | 审核意见 | 驳回时必填 |
| audit_time | DATETIME | 否 | 审核完成时间 | |
| pre_audit_node | TINYINT | 否 | 上一审核节点 | |
| next_audit_node | TINYINT | 否 | 下一审核节点 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 3.2 审核流程配置表 (audit_flow_configs)
定义不同票务类型的审核流程模板。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 审核流程配置主键ID | 主键, 自增 |
| config_name | VARCHAR(64) | 是 | 配置名称 | |
| ticket_type | TINYINT | 是 | 票务类型 | 索引 |
| flow_nodes | JSON | 是 | 流程节点配置 | |
| permission_rules | JSON | 否 | 权限规则配置 | |
| is_active | TINYINT | 是 | 是否启用 | 0-禁用 1-启用, 默认1 |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 3.3 审核规则配置表 (audit_rules)
定义自动审核或资质校验的规则。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 审核规则主键ID | 主键, 自增 |
| rule_name | VARCHAR(64) | 是 | 规则名称 | |
| qualification_type | TINYINT | 是 | 资质类型 | 索引 |
| rule_expression | TEXT | 是 | 规则表达式 | |
| rule_description | VARCHAR(255) | 否 | 规则描述 | |
| is_active | TINYINT | 是 | 是否启用 | 0-禁用 1-启用, 默认1 |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 3.4 操作审计日志表 (merchant_audit_logs)
记录关键业务操作日志。

| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 日志主键ID | 主键, 自增 |
| trace_id | VARCHAR(64) | 是 | 链路ID | 全流程追溯, 索引 |
| apply_id | BIGINT UNSIGNED | 否 | 关联入驻申请ID | 索引 |
| operator_id | VARCHAR(32) | 是 | 操作人ID | |
| operator_type | TINYINT | 是 | 操作人类型 | 1-商家 2-平台运营 3-系统 |
| operation_module | TINYINT | 是 | 操作模块 | 1-入驻申请 2-资质管理 3-审核流程 4-合同签署 5-店铺配置 |
| operation_type | TINYINT | 是 | 操作类型 | 1-新增 2-修改 3-删除 4-提交 5-审核 6-签署 |
| operation_content | JSON | 是 | 操作内容 | 变更前后数据 |
| operation_ip | VARCHAR(32) | 是 | 操作IP地址 | |
| operation_time | DATETIME | 是 | 操作时间 | 索引 |
| ticket_no | VARCHAR(64) | 是 | 关联工单编号 | |
| created_at | DATETIME | 是 | 记录创建时间 | |

## 4. 系统支撑模块 (System Support)

### 4.1 系统缓存记录表 (system_cache_records)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 缓存记录主键ID | 主键, 自增 |
| cache_key | VARCHAR(255) | 是 | 缓存键 | 唯一索引 |
| cache_value | TEXT | 否 | 缓存值 | |
| expire_time | DATETIME | 否 | 过期时间 | 索引 |
| hit_count | BIGINT UNSIGNED | 是 | 命中次数 | 默认0 |
| last_hit_time | DATETIME | 否 | 最后命中时间 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 4.2 消息队列记录表 (system_message_queues)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 消息队列记录主键ID | 主键, 自增 |
| message_id | VARCHAR(64) | 是 | 消息ID | 唯一索引 |
| exchange | VARCHAR(64) | 是 | 交换机名称 | 索引 |
| routing_key | VARCHAR(128) | 是 | 路由键 | 索引 |
| message_body | TEXT | 是 | 消息体 | |
| priority | TINYINT | 是 | 消息优先级 | 默认0 |
| headers | JSON | 否 | 消息头 | |
| status | TINYINT | 是 | 消息状态 | 0-待发送 1-已发送 2-发送失败 3-已消费 |
| retry_count | TINYINT | 是 | 重试次数 | 默认0 |
| error_message | VARCHAR(512) | 否 | 错误信息 | |
| created_at | DATETIME | 是 | 记录创建时间 | |
| updated_at | DATETIME | 是 | 记录更新时间 | |

### 4.3 监控指标记录表 (system_metric_records)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 指标记录主键ID | 主键, 自增 |
| metric_name | VARCHAR(128) | 是 | 指标名称 | 索引 |
| metric_type | VARCHAR(32) | 是 | 指标类型 | counter, gauge, histogram |
| value | DOUBLE | 是 | 指标值 | |
| labels | JSON | 否 | 指标标签 | |
| timestamp | DATETIME | 是 | 指标时间戳 | 索引 |
| created_at | DATETIME | 是 | 记录创建时间 | |

### 4.4 系统审计日志表 (system_audit_logs)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 审计日志主键ID | 主键, 自增 |
| log_id | VARCHAR(64) | 是 | 日志ID | 唯一索引 |
| operation_type | VARCHAR(64) | 是 | 操作类型 | 索引 |
| operator_id | VARCHAR(32) | 是 | 操作人ID | 索引 |
| operator_name | VARCHAR(64) | 是 | 操作人姓名 | |
| resource_type | VARCHAR(64) | 是 | 资源类型 | |
| resource_id | VARCHAR(64) | 是 | 资源ID | |
| details | JSON | 是 | 操作详情 | |
| ip_address | VARCHAR(45) | 是 | IP地址 | |
| user_agent | VARCHAR(512) | 否 | 用户代理 | |
| result | VARCHAR(32) | 是 | 操作结果 | |
| timestamp | DATETIME | 是 | 操作时间 | 索引 |
| created_at | DATETIME | 是 | 记录创建时间 | |

### 4.5 数据库查询记录表 (system_db_query_records)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 查询记录主键ID | 主键, 自增 |
| query_id | VARCHAR(64) | 是 | 查询ID | 唯一索引 |
| query_sql | TEXT | 是 | 查询SQL | |
| query_params | JSON | 否 | 查询参数 | |
| execution_time | INT UNSIGNED | 是 | 执行时间（毫秒） | |
| rows_examined | BIGINT UNSIGNED | 否 | 扫描行数 | |
| rows_returned | BIGINT UNSIGNED | 否 | 返回行数 | |
| indexes_used | JSON | 否 | 使用的索引 | |
| execution_plan | TEXT | 否 | 执行计划 | |
| is_slow_query | TINYINT | 是 | 是否慢查询 | 默认0 |
| database_name | VARCHAR(64) | 是 | 数据库名称 | |
| table_names | VARCHAR(255) | 否 | 涉及的表名 | |
| query_type | VARCHAR(32) | 是 | 查询类型 | SELECT, INSERT, UPDATE, DELETE |
| timestamp | DATETIME | 是 | 查询时间 | 索引 |
| created_at | DATETIME | 是 | 记录创建时间 | |

### 4.6 系统健康检查记录表 (system_health_checks)
| 字段名 | 类型 | 必填 | 描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| id | BIGINT UNSIGNED | 是 | 健康检查记录主键ID | 主键, 自增 |
| service_name | VARCHAR(64) | 是 | 服务名称 | 索引 |
| status | VARCHAR(32) | 是 | 健康状态 | |
| message | VARCHAR(512) | 否 | 状态消息 | |
| response_time | INT UNSIGNED | 是 | 响应时间（毫秒） | |
| check_time | DATETIME | 是 | 检查时间 | 索引 |
| created_at | DATETIME | 是 | 记录创建时间 | |
