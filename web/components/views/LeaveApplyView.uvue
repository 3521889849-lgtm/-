<template>
	<view class="leave-apply-view">
		<text class="section-title">提交申请</text>
		<view class="card">
			<view class="segmented-control">
				<view class="segment-item" :class="{ active: apply.apply_type === 0 }" @click="setApplyType(0)">
					<text class="segment-text" :class="{ 'active-text': apply.apply_type === 0 }">请假</text>
				</view>
				<view class="segment-item" :class="{ active: apply.apply_type === 1 }" @click="setApplyType(1)">
					<text class="segment-text" :class="{ 'active-text': apply.apply_type === 1 }">调班</text>
				</view>
			</view>

			<view class="form-group" style="margin-top: 24px;">
				<!-- 自动获取当前用户信息 -->
				<view class="field" v-if="currentUserName">
					<text class="form-label">申请人</text>
					<view class="readonly-info">{{ currentUserName }} ({{ apply.cs_id }})</view>
				</view>

				<!-- 开始日期和时段 -->
				<view class="row-group">
					<view class="field half">
						<text class="form-label">开始日期</text>
						<picker mode="date" :value="apply.start_date" @change="onStartDateChange">
							<view class="apple-input picker-text">{{ apply.start_date || '选择开始日期' }}</view>
						</picker>
					</view>
					<view class="field half">
						<text class="form-label">开始时段</text>
						<picker mode="selector" :range="periodOptions" :value="apply.start_period" @change="onStartPeriodChange">
							<view class="apple-input picker-text">{{ periodText(apply.start_period) }}</view>
						</picker>
					</view>
				</view>

				<!-- 结束日期和时段 -->
				<view class="row-group">
					<view class="field half">
						<text class="form-label">结束日期</text>
						<picker mode="date" :value="apply.end_date" @change="onEndDateChange">
							<view class="apple-input picker-text">{{ apply.end_date || '选择结束日期' }}</view>
						</picker>
					</view>
					<view class="field half">
						<text class="form-label">结束时段</text>
						<picker mode="selector" :range="periodOptions" :value="apply.end_period" @change="onEndPeriodChange">
							<view class="apple-input picker-text">{{ periodText(apply.end_period) }}</view>
						</picker>
					</view>
				</view>

				<!-- 请假类型选择（仅请假时显示） -->
				<view class="field" v-if="apply.apply_type === 0">
					<text class="form-label">请假类型</text>
					<picker mode="selector" :range="leaveTypeOptions" :value="apply.leave_type" @change="onLeaveTypeChange">
						<view class="apple-input picker-text">{{ leaveTypeText }}</view>
					</picker>
				</view>

				<!-- 班次选择 -->
				<view class="field">
					<text class="form-label">涉及班次</text>
					<picker mode="selector" :range="shiftNames" :value="apply.shift_index" @change="onShiftChange">
						<view class="apple-input picker-text">{{ currentShiftName || '选择班次' }}</view>
					</picker>
				</view>

				<!-- 调班对象 -->
				<view class="field" v-if="apply.apply_type === 1">
					<text class="form-label">调班对象</text>
					<picker mode="selector" :range="targetCandidateNames" :value="targetCandidateIndex" @change="onTargetCandidateChange">
						<view class="apple-input picker-text">{{ targetCandidateText || '请选择调班对象' }}</view>
					</picker>
					<!-- 优化后的目标班次显示 -->
					<view v-if="targetShiftInfo" class="target-info-box">
						<text class="target-info-label">对方班次信息：</text>
						<text class="target-info-value">{{ targetShiftInfo }}</text>
					</view>
					<text v-if="conflictWarning" class="hint-text" style="color: #ff3b30; margin-top: 8px;">⚠️ {{ conflictWarning }}</text>
				</view>

				<view class="field">
					<text class="form-label">申请原因</text>
					<input class="apple-input" v-model="apply.reason" placeholder="可选" />
				</view>

				<!-- 附件上传（仅请假时显示） -->
				<view class="field" v-if="apply.apply_type === 0">
					<text class="form-label">附件（可选）</text>
					<view class="attachment-area">
						<button class="small-btn" @click="chooseAttachment">+ 选择文件</button>
						<view class="attachment-list" v-if="attachments.length > 0">
							<view v-for="(file, idx) in attachments" :key="idx" class="attachment-item">
								<text class="attachment-name">{{ file.name }}</text>
								<text class="attachment-remove" @click="removeAttachment(idx)">×</text>
							</view>
						</view>
					</view>
				</view>

				<button class="apple-btn" @click="submitApply">提交申请</button>
				<text v-if="lastApplyId > 0" class="hint-text text-center">最新申请ID：{{ lastApplyId }}</text>
			</view>
		</view>
	</view>
</template>

<script>
	import { api } from '../../common/api.js'
	import { ensureOk } from '../../common/request.js'

	function todayYMD() {
		const d = new Date()
		const y = d.getFullYear()
		const m = String(d.getMonth() + 1).padStart(2, '0')
		const dd = String(d.getDate()).padStart(2, '0')
		return `${y}-${m}-${dd}`
	}

	export default {
		data() {
			return {
				lastApplyId: 0,
				shifts: [], // 班次列表
				periodOptions: ['全天', '上午', '下午'], // 时段选项
				leaveTypeOptions: ['事假', '病假', '年假', '调休', '其他'], // 请假类型选项
				attachments: [], // 附件列表 [{name, url}]
				apply: {
					cs_id: '',
					apply_type: 0,
					start_date: '',    // 开始日期
					end_date: '',      // 结束日期
					start_period: 0,   // 开始时段: 0=全天, 1=上午, 2=下午
					end_period: 0,     // 结束时段
					shift_index: -1,   // 班次索引
					target_cs_id: '',
					reason: '',
					leave_type: 0      // 请假类型: 0=事假, 1=病假, 2=年假, 3=调休, 4=其他
				},
				targetCandidates: [], // 可调班候选人列表
				targetCandidateIndex: -1,
				targetShiftInfo: '', // 目标客服班次信息
				conflictWarning: '',  // 冲突警告
				currentUserName: ''   // 当前用户姓名
			}
		},
		computed: {
			shiftNames() {
				return this.shifts.map((s) => `${s.shift_name} (${s.start_time.substring(0,5)}-${s.end_time.substring(0,5)})`)
			},
			currentShiftName() {
				if (this.apply.shift_index >= 0 && this.apply.shift_index < this.shiftNames.length) {
					return this.shiftNames[this.apply.shift_index]
				}
				return ''
			},
			currentShiftId() {
				if (this.apply.shift_index >= 0 && this.apply.shift_index < this.shifts.length) {
					return this.shifts[this.apply.shift_index].shift_id
				}
				return 0
			},
			// 请假类型文本显示
			leaveTypeText() {
				return this.leaveTypeOptions[this.apply.leave_type] || '事假'
			},
			targetCandidateNames() {
				return this.targetCandidates.map((c) => {
					const shift = `${c.shift_name} (${c.shift_time})`
					return `${c.cs_name} (${c.cs_id}) - ${shift}`
				})
			},
			targetCandidateText() {
				if (this.targetCandidateIndex >= 0 && this.targetCandidateIndex < this.targetCandidateNames.length) {
					return this.targetCandidateNames[this.targetCandidateIndex]
				}
				return ''
			}
		},
		mounted() {
			const today = todayYMD()
			this.apply.start_date = today
			this.apply.end_date = today
			this.loadShifts()
			// 自动获取当前登录用户信息
			this.loadCurrentUser()
		},
		methods: {
			setApplyType(type) {
				this.apply.apply_type = type
			},
			// 加载当前用户信息
			loadCurrentUser() {
				try {
					const userInfo = uni.getStorageSync('userInfo')
					if (userInfo) {
						const user = typeof userInfo === 'string' ? JSON.parse(userInfo) : userInfo
						this.apply.cs_id = user.user_name || user.cs_id || ''
						this.currentUserName = user.real_name || user.user_name || ''
					}
				} catch (e) {
					console.error('获取用户信息失败', e)
				}
			},
			// 请假类型变更
			onLeaveTypeChange(e) {
				this.apply.leave_type = parseInt(e.detail.value)
			},
			// 附件选择
			chooseAttachment() {
				uni.chooseImage({
					count: 3,
					success: (res) => {
						res.tempFilePaths.forEach(path => {
							this.attachments.push({
								name: path.substring(path.lastIndexOf('/') + 1) || '文件',
								url: path
							})
						})
					}
				})
			},
			// 移除附件
			removeAttachment(idx) {
				this.attachments.splice(idx, 1)
			},
			// 时段文本显示
			periodText(period) {
				return this.periodOptions[period] || '全天'
			},
			// 日期和时段变更处理
			onStartDateChange(e) {
				this.apply.start_date = e.detail.value
				// 自动调整结束日期
				if (this.apply.end_date < this.apply.start_date) {
					this.apply.end_date = this.apply.start_date
				}
				// 如果是调班模式，加载候选人列表
				if (this.apply.apply_type === 1) {
					this.loadSwapCandidates()
				}
			},
			onEndDateChange(e) {
				this.apply.end_date = e.detail.value
			},
			onStartPeriodChange(e) {
				this.apply.start_period = parseInt(e.detail.value)
			},
			onEndPeriodChange(e) {
				this.apply.end_period = parseInt(e.detail.value)
			},
			onShiftChange(e) {
				this.apply.shift_index = parseInt(e.detail.value)
			},
			// 加载班次列表
			async loadShifts() {
				try {
					const res = await api.listShiftConfig({ is_holiday: -1 })
					ensureOk(res)
					this.shifts = res.shifts || []
				} catch (e) {
					console.error('加载班次失败', e)
				}
			},
			// 加载调班候选人
			async loadSwapCandidates() {
				if (!this.apply.cs_id || !this.apply.start_date) return
				try {
					const res = await api.getSwapCandidates({
						cs_id: this.apply.cs_id,
						target_date: this.apply.start_date
					})
					if (res && res.base_resp && res.base_resp.code === 0) {
						this.targetCandidates = res.candidates || []
						this.targetCandidateIndex = -1
						this.apply.target_cs_id = ''
						this.updateTargetShiftInfo()
					}
				} catch (e) {
					console.error('加载调班候选人失败', e)
				}
			},
			onTargetCandidateChange(e) {
				const idx = parseInt(e.detail.value)
				this.targetCandidateIndex = idx
				if (idx >= 0 && idx < this.targetCandidates.length) {
					this.apply.target_cs_id = this.targetCandidates[idx].cs_id
					this.updateTargetShiftInfo()
					this.checkConflict()
				}
			},
			// 更新目标客服班次信息显示
			updateTargetShiftInfo() {
				const targetId = (this.apply.target_cs_id || '').trim()
				if (!targetId || this.targetCandidates.length === 0) {
					this.targetShiftInfo = ''
					return
				}
				const candidate = this.targetCandidates.find(c => c.cs_id === targetId)
				if (candidate) {
					this.targetShiftInfo = `对方班次：${candidate.shift_name} (${candidate.shift_start}-${candidate.shift_end})`
				} else {
					this.targetShiftInfo = '未找到该客服当日排班信息'
				}
			},
			// 目标客服ID输入失去焦点
			onTargetCsIdBlur() {
				this.updateTargetShiftInfo()
				this.checkConflict()
			},
			// 检测调班冲突
			async checkConflict() {
				const initiatorId = (this.apply.cs_id || '').trim()
				const targetId = (this.apply.target_cs_id || '').trim()
				const date = this.apply.start_date
				
				if (!initiatorId || !targetId || !date || this.apply.apply_type !== 1) {
					this.conflictWarning = ''
					return
				}

				try {
					const res = await api.checkSwapConflict({
						initiator_cs_id: initiatorId,
						target_cs_id: targetId,
						target_date: date
					})
					if (res && res.base_resp && res.base_resp.code !== 0) {
						// 有冲突 (code=409 in backend, here check logic might depend on how ensureOk works or custom handling)
						// CheckSwapConflict returns code=0 if ok, non-zero if conflict? 
						// Actually backend returns 409 if conflict. But ensureOk might throw.
						// Let's manually check base_resp.
						if (res.has_conflict) {
							this.conflictWarning = res.conflict_reason || '存在调班冲突'
						} else {
							this.conflictWarning = ''
						}
					} else {
						// check for boolean flag if API structure differs, but assuming has_conflict
						if (res.has_conflict) {
							this.conflictWarning = res.conflict_reason
						} else {
							this.conflictWarning = ''
						}
					}
				} catch (e) {
					console.error('冲突检测失败', e)
				}
			},
			async submitApply() {
				const startDate = (this.apply.start_date || '').trim()
				const endDate = (this.apply.end_date || '').trim()
				const shiftId = this.currentShiftId
				const targetCsId = (this.apply.target_cs_id || '').trim()

				if (!startDate) {
					uni.showToast({ title: '请选择开始日期', icon: 'none' })
					return
				}
				if (!endDate) {
					uni.showToast({ title: '请选择结束日期', icon: 'none' })
					return
				}
				if (shiftId <= 0) {
					uni.showToast({ title: '请选择班次', icon: 'none' })
					return
				}
				if (this.apply.apply_type === 1 && !targetCsId) {
					uni.showToast({ title: '请输入调班对象ID', icon: 'none' })
					return
				}

				try {
					uni.showLoading({ title: '提交中' })
					// 后端会自动从token获取申请人信息，不需要传cs_id
					const res = await api.applyLeaveTransfer({
						apply_type: this.apply.apply_type,
						target_date: startDate,      // 兼容旧字段
						start_date: startDate,
						end_date: endDate,
						start_period: this.apply.start_period,
						end_period: this.apply.end_period,
						shift_id: shiftId,
						target_cs_id: targetCsId,
						reason: (this.apply.reason || '').trim(),
						leave_type: this.apply.leave_type,
						attachments: JSON.stringify(this.attachments.map(f => f.url))
					})
					uni.hideLoading()
					ensureOk(res)
					this.lastApplyId = res.apply_id || 0
					uni.showToast({ title: '提交成功' })
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: '提交失败',
						content: e.errMsg || '未知错误',
						showCancel: false
					})
				}
			}
		}
	}
</script>

<style>
	.field {
		margin-bottom: 20px;
	}

	.row-group {
		flex-direction: row;
		justify-content: space-between;
	}

	.half {
		width: 48%;
	}

	.picker-text {
		height: 50px;
		line-height: 22px;
		color: #1d1d1f;
	}

	.hint-text {
		font-size: 13px;
		color: #86868b;
		margin-top: 12px;
	}

	.text-center {
		text-align: center;
	}

	.segmented-control {
		flex-direction: row;
		background-color: #f5f5f7;
		border-radius: 9px;
		padding: 2px;
	}

	.segment-item {
		flex: 1;
		padding: 8px 0;
		border-radius: 7px;
		align-items: center;
		justify-content: center;
	}

	.segment-item.active {
		background-color: #ffffff;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}

	.segment-text {
		font-size: 14px;
		font-weight: 500;
		color: #86868b;
	}

	.active-text {
		color: #1d1d1f;
		font-weight: 600;
	}

	/* 附件上传区域样式 */
	.attachment-area {
		flex-direction: column;
	}

	.small-btn {
		padding: 8px 16px;
		background-color: #f5f5f7;
		border-radius: 6px;
		border: none;
		font-size: 13px;
		color: #0071e3;
		font-weight: 500;
		align-self: flex-start;
	}

	.attachment-list {
		margin-top: 12px;
	}

	.attachment-item {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		background-color: #f5f5f7;
		padding: 8px 12px;
		border-radius: 6px;
		margin-bottom: 8px;
	}

	.attachment-name {
		font-size: 13px;
		color: #1d1d1f;
		flex: 1;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.attachment-remove {
		font-size: 18px;
		color: #ff3b30;
		margin-left: 12px;
		font-weight: 500;
	}

	.readonly-info {
		height: 50px;
		line-height: 50px;
		padding: 0 14px;
		background-color: #f5f5f7;
		border-radius: 12px;
		font-size: 15px;
		color: #1d1d1f;
	}

	.target-info-box {
		margin-top: 12px;
		padding: 12px;
		background-color: #f0f7ff;
		border-radius: 8px;
		border-left: 4px solid #0071e3;
	}

	.target-info-label {
		font-size: 12px;
		color: #0071e3;
		font-weight: 500;
		margin-bottom: 4px;
		display: block;
	}

	.target-info-value {
		font-size: 14px;
		color: #1d1d1f;
		font-weight: 600;
	}
</style>
