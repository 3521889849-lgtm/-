<template>
	<view class="chain-swap-apply-view">
		<text class="section-title">é“¾å¼è°ƒç­ç”³è¯·</text>
		<view class="card">
			<view class="info-tip">
				<text class="tip-text">ğŸ’¡ é“¾å¼è°ƒç­æ”¯æŒå¤šäººäº’æ¢ç­æ¬¡ï¼Œä¾‹å¦‚ï¼šAâ†’Bâ†’C æˆ– Aâ†’Bâ†’Câ†’A</text>
			</view>

			<view class="form-group">
				<!-- è‡ªåŠ¨è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
				<view class="field" v-if="currentUserName">
					<text class="form-label">ç”³è¯·äºº</text>
					<view class="readonly-info">{{ currentUserName }} ({{ form.applicant_id }})</view>
				</view>

				<view class="field" v-if="form.dept_id">
					<text class="form-label">æ‰€å±éƒ¨é—¨</text>
					<view class="readonly-info">{{ form.dept_id }}</view>
				</view>

				<view class="field">
					<text class="form-label">ç”³è¯·åŸå› </text>
					<input class="apple-input" v-model="form.reason" placeholder="è¯·è¾“å…¥è°ƒç­åŸå› " />
				</view>
			</view>

			<!-- è°ƒç­é“¾è·¯ -->
			<view class="chain-section">
				<view class="section-header">
					<text class="section-subtitle">è°ƒç­é“¾è·¯</text>
					<button class="small-btn" @click="addChainItem">+ æ·»åŠ æ­¥éª¤</button>
				</view>

				<view class="chain-list">
					<view class="chain-item" v-for="(item, index) in form.items" :key="index">
						<view class="chain-header">
							<text class="chain-step">æ­¥éª¤ {{ index + 1 }}</text>
							<text class="chain-remove" @click="removeChainItem(index)" v-if="form.items.length > 2">åˆ é™¤</text>
						</view>
						
						<view class="field">
							<text class="form-label-small">å®¢æœID</text>
							<input class="apple-input-small" v-model="item.cs_id" placeholder="KF001" />
						</view>

						<view class="row-group">
							<view class="field half">
								<text class="form-label-small">ä»æ’ç­ID</text>
								<input class="apple-input-small" type="number" v-model="item.from_schedule_id_str" placeholder="åŸæ’ç­" />
							</view>
							<view class="field half">
								<text class="form-label-small">åˆ°æ’ç­ID</text>
								<input class="apple-input-small" type="number" v-model="item.to_schedule_id_str" placeholder="ç›®æ ‡æ’ç­" />
							</view>
						</view>

						<view class="chain-arrow" v-if="index < form.items.length - 1">
							<text class="arrow-icon">â†“</text>
						</view>
					</view>
				</view>
			</view>

			<button class="apple-btn" @click="submitChainSwap">æäº¤é“¾å¼è°ƒç­ç”³è¯·</button>
			<text v-if="lastRequestId > 0" class="hint-text text-center">ç”³è¯·IDï¼š{{ lastRequestId }}</text>
		</view>
	</view>
</template>

<script>
	import { api } from '../../common/api.js'
	import { ensureOk } from '../../common/request.js'

	export default {
		data() {
			return {
				lastRequestId: 0,
				form: {
					applicant_id: '',
					dept_id: '',
					reason: '',
					items: [
						{ cs_id: '', from_schedule_id_str: '', to_schedule_id_str: '', step: 1 },
						{ cs_id: '', from_schedule_id_str: '', to_schedule_id_str: '', step: 2 }
					]
				},
				currentUserName: ''   // å½“å‰ç”¨æˆ·å§“å
			}
		},
		mounted() {
			// è‡ªåŠ¨è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
			this.loadCurrentUser()
		},
		methods: {
			// åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
			loadCurrentUser() {
				try {
					const userInfo = uni.getStorageSync('userInfo')
					if (userInfo) {
						const user = typeof userInfo === 'string' ? JSON.parse(userInfo) : userInfo
						this.form.applicant_id = user.user_name || user.cs_id || ''
						this.form.dept_id = user.dept_id || 'DEFAULT'
						this.currentUserName = user.real_name || user.user_name || ''
					}
				} catch (e) {
					console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', e)
				}
			},
			addChainItem() {
				this.form.items.push({
					cs_id: '',
					from_schedule_id_str: '',
					to_schedule_id_str: '',
					step: this.form.items.length + 1
				})
			},
			removeChainItem(index) {
				this.form.items.splice(index, 1)
				// é‡æ–°è°ƒæ•´stepç¼–å·
				this.form.items.forEach((item, idx) => {
					item.step = idx + 1
				})
			},
			async submitChainSwap() {
				const deptId = (this.form.dept_id || '').trim()
				const reason = (this.form.reason || '').trim()

				if (!deptId) {
					uni.showToast({ title: 'è¯·è¾“å…¥æ‰€å±éƒ¨é—¨', icon: 'none' })
					return
				}

				if (this.form.items.length < 2) {
					uni.showToast({ title: 'è‡³å°‘éœ€è¦2ä¸ªè°ƒç­æ­¥éª¤', icon: 'none' })
					return
				}

				// éªŒè¯æ¯ä¸ªæ­¥éª¤çš„æ•°æ®
				for (let i = 0; i < this.form.items.length; i++) {
					const item = this.form.items[i]
					if (!item.cs_id || !item.cs_id.trim()) {
						uni.showToast({ title: `æ­¥éª¤${i + 1}ï¼šè¯·è¾“å…¥å®¢æœID`, icon: 'none' })
						return
					}
					const fromId = parseInt(item.from_schedule_id_str, 10)
					const toId = parseInt(item.to_schedule_id_str, 10)
					if (Number.isNaN(fromId) || fromId <= 0) {
						uni.showToast({ title: `æ­¥éª¤${i + 1}ï¼šåŸæ’ç­IDæ— æ•ˆ`, icon: 'none' })
						return
					}
					if (Number.isNaN(toId) || toId <= 0) {
						uni.showToast({ title: `æ­¥éª¤${i + 1}ï¼šç›®æ ‡æ’ç­IDæ— æ•ˆ`, icon: 'none' })
						return
					}
				}

				try {
					uni.showLoading({ title: 'æäº¤ä¸­' })
					// åç«¯ä¼šè‡ªåŠ¨ä»tokenè·å–ç”³è¯·äººä¿¡æ¯ï¼Œä¸éœ€è¦ä¼ applicant_id
					const payload = {
						dept_id: deptId,
						reason: reason,
						items: this.form.items.map((item, index) => ({
							cs_id: item.cs_id.trim(),
							from_schedule_id: parseInt(item.from_schedule_id_str, 10),
							to_schedule_id: parseInt(item.to_schedule_id_str, 10),
							step: index + 1
						}))
					}

					const res = await api.applyChainSwap(payload)
					uni.hideLoading()
					ensureOk(res)
					this.lastRequestId = res.request_id || 0
					uni.showToast({ title: 'æäº¤æˆåŠŸ' })
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'æäº¤å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			}
		}
	}
</script>

<style>
	.info-tip {
		background-color: #f0f9ff;
		border-left: 3px solid #0071e3;
		padding: 12px;
		margin-bottom: 20px;
		border-radius: 6px;
	}

	.tip-text {
		font-size: 13px;
		color: #0071e3;
		line-height: 1.6;
	}

	.chain-section {
		margin-top: 24px;
		margin-bottom: 24px;
	}

	.section-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 16px;
	}

	.section-subtitle {
		font-size: 15px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.small-btn {
		padding: 6px 12px;
		background-color: #f5f5f7;
		border-radius: 6px;
		border: none;
		font-size: 13px;
		color: #0071e3;
		font-weight: 500;
	}

	.chain-list {
		/* no style */
	}

	.chain-item {
		background-color: #f9f9f9;
		padding: 16px;
		border-radius: 8px;
		margin-bottom: 16px;
	}

	.chain-header {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
	}

	.chain-step {
		font-size: 14px;
		font-weight: 600;
		color: #0071e3;
	}

	.chain-remove {
		font-size: 13px;
		color: #ff3b30;
		text-decoration: underline;
	}

	.form-label-small {
		font-size: 13px;
		font-weight: 500;
		color: #1d1d1f;
		margin-bottom: 6px;
	}

	.apple-input-small {
		height: 44px;
		line-height: 44px;
		padding: 0 12px;
		background-color: #ffffff;
		border: 1px solid #d2d2d7;
		border-radius: 6px;
		font-size: 14px;
		color: #1d1d1f;
	}

	.chain-arrow {
		align-items: center;
		justify-content: center;
		margin-top: 8px;
		margin-bottom: 8px;
	}

	.arrow-icon {
		font-size: 24px;
		color: #86868b;
	}

	.row-group {
		flex-direction: row;
		justify-content: space-between;
	}

	.field {
		margin-bottom: 16px;
	}

	.half {
		width: 48%;
	}

	.hint-text {
		font-size: 13px;
		color: #86868b;
		margin-top: 12px;
	}

	.text-center {
		text-align: center;
	}

	.readonly-info {
		height: 50px;
		line-height: 50px;
		padding: 0 14px;
		background-color: #f5f5f7;
		border-radius: 12px;
		font-size: 15px;
		color: #1d1d1f;
	}
</style>
