<template>
	<view class="transfer-view">
		<text class="section-title">客服会话管理</text>

		<view class="card">
			<view class="segmented-control">
				<view class="segment-item" :class="{ active: mode === 'live' }" @click="setMode('live')">
					<text class="segment-text" :class="{ 'active-text': mode === 'live' }">会话</text>
				</view>
				<view class="segment-item" :class="{ active: mode === 'record' }" @click="setMode('record')">
					<text class="segment-text" :class="{ 'active-text': mode === 'record' }">记录</text>
				</view>
			</view>
		</view>

		<view class="card" style="margin-top: 16px;">
			<view class="toolbar">
				<input class="apple-input toolbar-search" v-model="convKeyword" placeholder="搜索会话ID/用户ID/昵称" />
				<button class="apple-btn apple-btn-small" @click="reloadConversations">刷新</button>
			</view>
			<view class="toolbar" style="margin-top: 10px;">
				<picker mode="selector" :range="statusOptionsText" :value="statusIndex" @change="onStatusChange">
					<view class="apple-input toolbar-picker">{{ statusOptionsText[statusIndex] }}</view>
				</picker>
				<picker v-if="isAdmin" mode="selector" :range="csOptionsText" :value="csIndex" @change="onCsChange">
					<view class="apple-input toolbar-picker">{{ csOptionsText[csIndex] }}</view>
				</picker>
			</view>
		</view>

	<view class="layout" :class="{ 'layout-record': mode === 'record' }">
			<view class="pane pane-left">
				<text class="pane-title">会话列表</text>
				<view class="pane-body">
					<view v-if="conversations.length === 0" class="empty-state">
						<text class="empty-text">暂无会话</text>
					</view>
					<scroll-view v-else scroll-y="true" class="list-scroll">
						<view
							v-for="c in conversations"
							:key="c.conv_id"
							class="conv-item"
							:class="{ selected: selectedConv && selectedConv.conv_id === c.conv_id }"
							@click="selectConversation(c)"
						>
							<view class="conv-top">
								<text class="conv-title">{{ c.user_nickname || c.user_id || c.conv_id }}</text>
								<text class="conv-time">{{ c.last_time }}</text>
							</view>
							<text class="conv-sub">{{ c.conv_id }} · {{ c.source || '-' }}</text>
							<text class="conv-last">{{ c.last_msg || '' }}</text>
						</view>
					</scroll-view>
				</view>
			</view>

			<view class="pane pane-mid">
				<text class="pane-title">对话</text>
				<view class="pane-body">
					<view v-if="!selectedConv" class="empty-state">
						<text class="empty-text">请选择左侧会话</text>
					</view>
					<view v-else class="chat-body">
						<view class="chat-header">
							<view class="chat-header-main">
								<text class="chat-title">{{ selectedConv.user_nickname || selectedConv.user_id }}</text>
								<text class="chat-sub">手机号：{{ selectedUserPhone }}</text>
								<text class="chat-sub">客服编号：{{ selectedConv.cs_id || '-' }}</text>
							</view>
							<view v-if="mode === 'live'" class="chat-header-actions">
								<button class="apple-btn apple-btn-small" @click="openTransfer">转接</button>
								<button class="apple-btn apple-btn-small apple-btn-danger" style="margin-left: 8px;" @click="openEndDialog">结束</button>
							</view>
						</view>

						<view class="toolbar" style="margin-bottom: 10px;">
							<input class="apple-input toolbar-search" style="margin-right: 0;" v-model="msgKeyword" placeholder="搜索消息内容" />
						</view>

						<scroll-view scroll-y="true" class="chat-list">
							<view v-for="m in filteredMessages" :key="m.msg_id" class="msg-row" :class="{ mine: m.sender_type === 1 }">
								<text class="msg-meta">{{ m.send_time }} · {{ m.sender_id }}</text>
								<view class="msg-bubble">
									<text class="msg-text">{{ m.msg_content }}</text>
								</view>
							</view>
						</scroll-view>

						<view v-if="mode === 'live'" class="chat-input">
							<input class="apple-input chat-text" v-model="inputText" placeholder="输入消息..." />
							<button class="apple-btn apple-btn-small" @click="sendText">发送</button>
						</view>
					</view>
				</view>
			</view>

			<view v-if="mode === 'live'" class="pane pane-right">
				<text class="pane-title">资料/快捷</text>
				<scroll-view scroll-y="true" class="right-scroll">
					<view v-if="selectedConv" class="info-card">
						<text class="info-line">用户：{{ selectedConv.user_id }}</text>
						<text class="info-line">昵称：{{ selectedConv.user_nickname || '-' }}</text>
						<text class="info-line">来源：{{ selectedConv.source || '-' }}</text>
						<text class="info-line">接待：{{ selectedConv.cs_id || '-' }}</text>
					</view>

					<view class="info-card" style="margin-top: 12px;">
						<view class="form-group">
							<picker mode="selector" :range="categoryOptionsText" :value="categoryIndex" @change="onCategoryChange">
								<view class="apple-input toolbar-picker">{{ categoryOptionsText[categoryIndex] }}</view>
							</picker>
							<input class="apple-input" style="margin-top: 10px;" v-model="classifyTags" placeholder="标签（逗号分隔）" />
							<view class="switch-row">
								<text class="switch-text">核心数据</text>
								<switch :checked="classifyIsCore" @change="onCoreChange"></switch>
							</view>
							<button class="apple-btn apple-btn-small" style="margin-top: 10px;" @click="saveClassify">保存分类</button>
						</view>
					</view>

					<view class="info-card" style="margin-top: 12px;">
						<view class="toolbar" style="margin-bottom: 10px;">
							<input class="apple-input toolbar-search" v-model="quickKeyword" placeholder="搜索快捷回复" />
							<button class="apple-btn apple-btn-small" @click="reloadQuickReplies">刷新</button>
						</view>
						<view v-if="quickReplies.length === 0" class="empty-state" style="padding: 16px 0;">
							<text class="empty-text">暂无快捷回复</text>
						</view>
						<view v-else class="quick-list">
							<view v-for="q in filteredQuickReplies" :key="q.reply_id" class="quick-item" @click="useQuickReply(q)">
								<text class="quick-text">{{ q.reply_content }}</text>
							</view>
						</view>
					</view>
				</scroll-view>
			</view>
		</view>

		<!-- 转接弹窗 -->
		<view v-if="showTransferDialog" class="modal-overlay" @click="closeTransferDialog">
			<view class="modal-content" @click.stop>
				<text class="modal-title">选择转接客服</text>
				<picker mode="selector" :range="transferCsNames" :value="transferTargetIndex" @change="onTransferCsChange">
					<view class="picker-input">
						{{ transferCsNames[transferTargetIndex] || '请选择客服' }}
					</view>
				</picker>
				<view class="modal-actions">
					<button class="apple-btn apple-btn-secondary" @click="closeTransferDialog">取消</button>
					<button class="apple-btn" @click="confirmTransfer">确认转接</button>
				</view>
			</view>
		</view>

		<!-- 结束会话弹窗 -->
		<view v-if="showEndDialog" class="modal-overlay" @click="closeEndDialog">
			<view class="modal-content" @click.stop>
				<text class="modal-title">结束会话</text>
				<text class="modal-desc">确认结束与 "{{ selectedConv ? (selectedConv.user_nickname || selectedConv.user_id) : '' }}" 的会话？</text>
				<input class="apple-input" style="margin-top: 12px;" v-model="endReason" placeholder="结束原因（可选）" />
				<view class="modal-actions">
					<button class="apple-btn apple-btn-secondary" @click="closeEndDialog">取消</button>
					<button class="apple-btn apple-btn-danger" @click="confirmEndConversation">确认结束</button>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import { api } from '../../common/api.js'
	import { ensureOk } from '../../common/request.js'

	export default {
		data() {
			return {
				mode: 'live',
				convKeyword: '',
				conversations: [],
				selectedConv: null,
				messages: [],
				msgKeyword: '',
				inputText: '',

				customers: [],
				csIndex: 0,

				statusIndex: 0,
				roleCode: '',

				quickReplies: [],
				quickKeyword: '',

				categories: [],
				categoryIndex: 0,
				classifyTags: '',
				classifyIsCore: false,

				showTransferDialog: false,
				transferTargetIndex: 0,
				manualTargetCsId: '',

				// 结束会话相关
				showEndDialog: false,
				endReason: '',

				// WebSocket 相关
				wsSocket: null,
				wsConnected: false,
				currentUserId: 0
			}
		},
		computed: {
			isAdmin() {
				return this.roleCode === 'admin'
			},
			transferCsList() {
				return this.customers || []
			},
			transferCsNames() {
				return this.transferCsList.map((c) => `${c.cs_name} (${c.cs_id})`)
			},
			statusOptions() {
				if (this.mode === 'record') {
					return [
						{ text: '全部历史', value: -1 },
						{ text: '已结束', value: 0 },
						{ text: '已转接', value: 2 }
					]
				}
				return [
					{ text: '全部状态', value: -1 },
					{ text: '进行中', value: 1 },
					{ text: '已结束', value: 0 },
					{ text: '已转接', value: 2 }
				]
			},
			statusOptionsText() {
				return this.statusOptions.map((x) => x.text)
			},
			csOptions() {
				const opts = [{ text: '全部客服', value: '' }]
				;(this.customers || []).forEach((c) => {
					opts.push({ text: `${c.cs_name}(${c.cs_id})`, value: c.cs_id })
				})
				return opts
			},
			csOptionsText() {
				return this.csOptions.map((x) => x.text)
			},
			selectedCsId() {
				return (this.csOptions[this.csIndex] && this.csOptions[this.csIndex].value) || ''
			},
			selectedStatus() {
				return (this.statusOptions[this.statusIndex] && this.statusOptions[this.statusIndex].value) ?? -1
			},
			categoryOptions() {
				const opts = [{ text: '未分类', value: 0 }]
				;(this.categories || []).forEach((c) => {
					opts.push({ text: c.category_name, value: c.category_id })
				})
				return opts
			},
			categoryOptionsText() {
				return this.categoryOptions.map((x) => x.text)
			},
			filteredQuickReplies() {
				const kw = (this.quickKeyword || '').trim().toLowerCase()
				if (!kw) return this.quickReplies
				return this.quickReplies.filter((q) => String(q.reply_content || '').toLowerCase().includes(kw))
			},
			filteredMessages() {
				let base = this.messages || []
				if (this.mode === 'record') {
					base = base.filter((m) => m && m.sender_type !== 2)
				}
				const kw = (this.msgKeyword || '').trim().toLowerCase()
				if (!kw) return base
				return base.filter((m) => {
					const content = String(m.msg_content || '').toLowerCase()
					const sender = String(m.sender_id || '').toLowerCase()
					const sendTime = String(m.send_time || '').toLowerCase()
					return content.includes(kw) || sender.includes(kw) || sendTime.includes(kw)
				})
			},
			selectedUserPhone() {
				if (!this.selectedConv) return '-'
				const raw = String(this.selectedConv.user_phone || this.selectedConv.phone || '').trim()
				if (raw) return raw
				const uid = String(this.selectedConv.user_id || '').trim()
				if (/^1\d{10}$/.test(uid)) return uid
				return '-'
			}
		},
		mounted() {
			this.loadInit()
			this.connectWebSocket()
		},
		beforeDestroy() {
			this.closeWebSocket()
		},
		methods: {
			setMode(m) {
				this.mode = m
				this.statusIndex = 0
				this.selectedConv = null
				this.messages = []
				this.msgKeyword = ''
				this.reloadConversations()
			},
			onStatusChange(e) {
				this.statusIndex = parseInt(e.detail.value, 10) || 0
				this.reloadConversations()
			},
			onCsChange(e) {
				this.csIndex = parseInt(e.detail.value, 10) || 0
				this.reloadConversations()
			},
			onCategoryChange(e) {
				this.categoryIndex = parseInt(e.detail.value, 10) || 0
			},
			onCoreChange(e) {
				this.classifyIsCore = e.detail.value === true
			},
			async loadInit() {
				this.loadRoleInfo()
				await Promise.all([this.loadCustomers(), this.loadCategories(), this.reloadQuickReplies()])
				await this.reloadConversations()
			},
			loadRoleInfo() {
				try {
					const userInfoStr = uni.getStorageSync('userInfo')
					if (userInfoStr != null && userInfoStr !== '') {
						let userInfo = null
						if (typeof userInfoStr === 'string') {
							try {
								userInfo = JSON.parse(userInfoStr)
							} catch (e) {
								userInfo = null
							}
						} else {
							userInfo = userInfoStr
						}
						if (userInfo) {
							this.roleCode = userInfo['role_code'] || ''
						}
					}
				} catch (e) {
					this.roleCode = ''
				}
			},
			async loadCustomers() {
				try {
					const res = await api.listCustomerService({ page: 1, page_size: 1000 })
					ensureOk(res)
					this.customers = res.customer_services || []
				} catch (e) {
					this.customers = []
					console.error(e)
				}
			},
			async loadCategories() {
				try {
					const res = await api.listConvCategory({})
					ensureOk(res)
					this.categories = res.categories || []
				} catch (e) {
					this.categories = []
					console.error(e)
				}
			},
			async reloadConversations() {
				try {
					uni.showLoading({ title: '加载中' })
					const listFn = this.mode === 'record' ? api.listConversationHistory : api.listConversation
					const res = await listFn({
						cs_id: this.selectedCsId,
						keyword: this.convKeyword,
						status: this.selectedStatus,
						page: 1,
						page_size: 50
					})
					uni.hideLoading()
					ensureOk(res)
					this.conversations = res.conversations || []
					if (this.selectedConv) {
						const found = this.conversations.find((c) => c.conv_id === this.selectedConv.conv_id)
						if (found) this.selectedConv = found
					}
				} catch (e) {
					uni.hideLoading()
					this.conversations = []
					console.error(e)
				}
			},
			async selectConversation(conv) {
				this.selectedConv = conv
				this.inputText = ''
				this.messages = []
				this.msgKeyword = ''
				this.classifyTags = conv.tags || ''
				this.classifyIsCore = conv.is_core === 1
				const idx = this.categoryOptions.findIndex((x) => x.value === (conv.category_id || 0))
				this.categoryIndex = idx >= 0 ? idx : 0
				await this.reloadMessages()
			},
			async reloadMessages() {
				if (!this.selectedConv) return
				try {
					const res = await api.listConversationMessage({
						conv_id: this.selectedConv.conv_id,
						page: 1,
						page_size: 1000,
						order_asc: 1
					})
					ensureOk(res)
					this.messages = res.messages || []
				} catch (e) {
					this.messages = []
					console.error(e)
				}
			},
			// ============ WebSocket 相关方法 ============
			connectWebSocket() {
				const token = uni.getStorageSync('token')
				if (!token) {
					uni.showModal({ title: '连接失败', content: '未登录，无法建立WebSocket连接', showCancel: false })
					return
				}
				// 解析 token 获取 user_id
				try {
					const payload = JSON.parse(atob(token.split('.')[1]))
					this.currentUserId = payload.user_id || 0
				} catch (e) {
					uni.showModal({ title: '连接失败', content: '解析Token失败', showCancel: false })
					return
				}
				
				const wsUrl = 'ws://127.0.0.1:8081/ws?token=' + encodeURIComponent(token)
				console.log('WebSocket 连接:', wsUrl)
				
				this.wsSocket = uni.connectSocket({
					url: wsUrl,
					success: () => console.log('WebSocket 连接请求已发送')
				})
				
				uni.onSocketOpen(() => {
					console.log('WebSocket 已连接')
					this.wsConnected = true
					uni.showToast({ title: '实时连接已建立', icon: 'success' })
				})
				
				uni.onSocketMessage((res) => {
					console.log('WebSocket 收到消息:', res.data)
					this.handleWsMessage(res.data)
				})
				
				uni.onSocketError((err) => {
					console.error('WebSocket 错误:', err)
					this.wsConnected = false
					uni.showModal({ title: 'WebSocket错误', content: '实时连接失败，请检查网络', showCancel: false })
				})
				
				uni.onSocketClose(() => {
					console.log('WebSocket 已关闭')
					this.wsConnected = false
					uni.showToast({ title: '连接已断开，5秒后重连', icon: 'none' })
					// 5秒后尝试重连
					setTimeout(() => {
						if (!this.wsConnected) this.connectWebSocket()
					}, 5000)
				})
			},
			closeWebSocket() {
				if (this.wsSocket) {
					uni.closeSocket()
					this.wsSocket = null
					this.wsConnected = false
				}
			},
			handleWsMessage(data) {
				try {
					const msg = JSON.parse(data)
					if (msg.type === 'chat' && msg.payload) {
						const payload = msg.payload
						// 如果是当前会话的消息，追加到消息列表
						if (this.selectedConv && payload.conversation_id === this.selectedConv.conv_id) {
							this.messages.push({
								msg_id: Date.now(),
								conv_id: payload.conversation_id,
								sender_type: payload.from_user_id === this.currentUserId ? 1 : 0,
								sender_id: String(payload.from_user_id),
								msg_content: payload.content,
								send_time: payload.create_time || new Date().toLocaleString()
							})
						}
						// 刷新会话列表以更新最后消息
						this.reloadConversations()
					}
				} catch (e) {
					console.error('解析 WebSocket 消息失败', e)
				}
			},
			sendWsMessage(convId, content, toUserId) {
				if (!this.wsConnected) {
					uni.showModal({ title: '发送失败', content: 'WebSocket未连接，请稍后重试', showCancel: false })
					return false
				}
				const msg = {
					type: 'chat',
					payload: {
						conversation_id: convId,
						content: content,
						msg_type: 0,
						to_user_id: toUserId
					}
				}
				uni.sendSocketMessage({
					data: JSON.stringify(msg),
					success: () => console.log('WebSocket 消息已发送'),
					fail: (err) => {
						console.error('WebSocket 发送失败', err)
						uni.showModal({ title: '发送失败', content: '消息发送失败，请重试', showCancel: false })
					}
				})
				return true
			},
			
			// ============ 发送消息（使用 WebSocket） ============
			sendText() {
				if (!this.selectedConv) {
					uni.showToast({ title: '请先选择会话', icon: 'none' })
					return
				}
				const text = (this.inputText || '').trim()
				if (!text) {
					uni.showToast({ title: '请输入消息内容', icon: 'none' })
					return
				}
				
				if (!this.wsConnected) {
					uni.showModal({ title: '发送失败', content: 'WebSocket未连接，请稍后重试', showCancel: false })
					return
				}
				
				// 获取目标用户ID（从会话的 user_id 解析）
				const toUserId = parseInt(this.selectedConv.user_id) || 0
				if (toUserId <= 0) {
					uni.showModal({ title: '发送失败', content: '无法获取目标用户ID', showCancel: false })
					return
				}
				
				// 使用 WebSocket 发送
				if (this.sendWsMessage(this.selectedConv.conv_id, text, toUserId)) {
					this.inputText = ''
				}
			},
			async reloadQuickReplies() {
				try {
					const res = await api.listQuickReply({ page: 1, page_size: 200 })
					ensureOk(res)
					this.quickReplies = res.replies || []
				} catch (e) {
					this.quickReplies = []
					console.error(e)
				}
			},
			useQuickReply(q) {
				if (!q) return
				this.inputText = q.reply_content || ''
			},
			async saveClassify() {
				if (!this.selectedConv) {
					uni.showToast({ title: '请先选择会话', icon: 'none' })
					return
				}
				const opt = this.categoryOptions[this.categoryIndex]
				const categoryId = opt ? opt.value : 0
				try {
					uni.showLoading({ title: '保存中' })
					const res = await api.updateConversationClassify({
						conv_id: this.selectedConv.conv_id,
						category_id: categoryId,
						tags: this.classifyTags,
						is_core: this.classifyIsCore ? 1 : 0,
						operator_id: 'ADMIN'
					})
					uni.hideLoading()
					ensureOk(res)
					uni.showToast({ title: '已保存' })
					await this.reloadConversations()
				} catch (e) {
					uni.hideLoading()
					uni.showModal({ title: '保存失败', content: e.errMsg || '未知错误', showCancel: false })
				}
			},
			openTransfer() {
				if (!this.selectedConv) return
				this.showTransferDialog = true
				this.transferTargetIndex = 0
				this.manualTargetCsId = ''
			},
			closeTransferDialog() {
				this.showTransferDialog = false
			},
			onTransferCsChange(e) {
				this.transferTargetIndex = parseInt(e.detail.value, 10) || 0
				const target = this.transferCsList[this.transferTargetIndex]
				if (target) {
					this.manualTargetCsId = target.cs_id
				}
			},
			async confirmTransfer() {
				const targetId = (this.manualTargetCsId || '').trim()
				if (!targetId) {
					uni.showToast({ title: '请输入或选择客服', icon: 'none' })
					return
				}
				
				this.closeTransferDialog()
				await this.doTransfer(targetId)
			},
			async doTransfer(targetCsId) {
				try {
					uni.showLoading({ title: '转接中' })
					const res = await api.transferConversation({
						conv_id: this.selectedConv.conv_id,
						from_cs_id: this.selectedConv.cs_id,
						to_cs_id: targetCsId
					})
					uni.hideLoading()
					ensureOk(res)
					uni.showToast({ title: '转接成功' })
					await this.reloadConversations()
					await this.reloadMessages()
				} catch (e) {
					uni.hideLoading()
					uni.showModal({ title: '转接失败', content: e.errMsg || '未知错误', showCancel: false })
				}
			},

			// ============ 结束会话相关方法 ============
			openEndDialog() {
				if (!this.selectedConv) return
				this.showEndDialog = true
				this.endReason = ''
			},
			closeEndDialog() {
				this.showEndDialog = false
			},
			async confirmEndConversation() {
				if (!this.selectedConv) return
				
				this.closeEndDialog()
				try {
					uni.showLoading({ title: '结束中' })
					const res = await api.endConversation({
						conv_id: this.selectedConv.conv_id,
						end_reason: this.endReason || ''
					})
					uni.hideLoading()
					ensureOk(res)
					
					// 显示会话时长
					const duration = res.duration_seconds || 0
					const minutes = Math.floor(duration / 60)
					const seconds = duration % 60
					const timeStr = minutes > 0 ? `${minutes}分${seconds}秒` : `${seconds}秒`
					
					uni.showToast({ title: `会话已结束，时长${timeStr}`, icon: 'none', duration: 2000 })
					
					// 刷新会话列表和消息
					this.selectedConv = null
					await this.reloadConversations()
				} catch (e) {
					uni.hideLoading()
					uni.showModal({ title: '结束失败', content: e.errMsg || '未知错误', showCancel: false })
				}
			}
		}
	}
</script>

<style>
	.segmented-control {
		flex-direction: row;
		background-color: #f5f5f7;
		border-radius: 14px;
		padding: 4px;
	}

	.segment-item {
		flex: 1;
		height: 40px;
		align-items: center;
		justify-content: center;
		border-radius: 12px;
	}

	.segment-item.active {
		background-color: #ffffff;
		box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
	}

	.segment-text {
		color: #6e6e73;
		font-size: 14px;
		font-weight: 500;
	}

	.active-text {
		color: #1d1d1f;
	}

	.toolbar {
		flex-direction: row;
		align-items: center;
	}

	.toolbar-search {
		flex: 1;
		margin-right: 12px;
	}

	.toolbar-picker {
		flex: 1;
		margin-right: 12px;
		height: 44px;
		line-height: 22px;
		color: #1d1d1f;
	}

	.layout {
		flex-direction: row;
		margin-top: 16px;
		height: 72vh;
	}

	.layout-record .pane-left {
		width: 32%;
		margin-right: 14px;
	}

	.layout-record .pane-mid {
		width: 68%;
		margin-right: 0;
	}

	.pane {
		background-color: #ffffff;
		border-radius: 18px;
		padding: 16px;
		box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
		height: 100%;
		overflow: hidden;
		display: flex;
		flex-direction: column;
	}

	.pane-left {
		width: 32%;
		margin-right: 14px;
	}

	.pane-mid {
		width: 40%;
		margin-right: 14px;
	}

	.pane-right {
		width: 28%;
	}

	.chat-header-main {
		flex: 1;
	}

	.chat-sub {
		color: #6e6e73;
		font-size: 12px;
		margin-top: 2px;
	}

	.pane-title {
		font-size: 16px;
		font-weight: 600;
		color: #1d1d1f;
		margin-bottom: 12px;
	}

	.pane-body {
		flex: 1;
		height: 0;
	}

	.list-scroll {
		flex: 1;
		height: 0;
		border-top: 1px solid #f5f5f7;
	}

	.conv-item {
		padding: 14px 0;
		border-bottom: 1px solid #f5f5f7;
	}

	.conv-item.selected {
		background-color: rgba(0, 113, 227, 0.06);
	}

	.conv-top {
		flex-direction: row;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 4px;
	}

	.conv-title {
		font-size: 16px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.conv-time {
		font-size: 12px;
		color: #86868b;
	}

	.conv-sub {
		font-size: 12px;
		color: #86868b;
	}

	.conv-last {
		font-size: 13px;
		color: #1d1d1f;
		margin-top: 6px;
		lines: 2;
	}

	.chat-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 10px;
	}

	.chat-title {
		font-size: 15px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.chat-list {
		flex: 1;
		height: 0;
		border-top: 1px solid #f5f5f7;
		border-bottom: 1px solid #f5f5f7;
		padding-top: 10px;
		padding-bottom: 10px;
	}

	.chat-body {
		flex: 1;
		height: 0;
		display: flex;
		flex-direction: column;
	}

	.msg-row {
		margin-bottom: 12px;
	}

	.msg-row.mine {
		align-items: flex-end;
	}

	.msg-meta {
		font-size: 11px;
		color: #86868b;
		margin-bottom: 6px;
	}

	.msg-bubble {
		max-width: 90%;
		background-color: #f5f5f7;
		padding: 10px 12px;
		border-radius: 14px;
	}

	.msg-row.mine .msg-bubble {
		background-color: rgba(0, 113, 227, 0.12);
	}

	.msg-text {
		color: #1d1d1f;
		font-size: 14px;
		line-height: 20px;
	}

	.chat-input {
		flex-direction: row;
		align-items: center;
		margin-top: 10px;
	}

	.chat-text {
		flex: 1;
		margin-right: 12px;
	}

	.info-card {
		background-color: #ffffff;
		border-radius: 16px;
		padding: 14px;
		border: 1px solid #f5f5f7;
	}

	.info-line {
		font-size: 13px;
		color: #1d1d1f;
		margin-bottom: 6px;
	}

	.switch-row {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-top: 10px;
	}

	.switch-text {
		font-size: 13px;
		color: #1d1d1f;
	}

	.quick-list {
		border-top: 1px solid #f5f5f7;
	}

	.quick-item {
		padding: 12px 0;
		border-bottom: 1px solid #f5f5f7;
	}

	.quick-text {
		font-size: 13px;
		color: #1d1d1f;
		lines: 2;
	}

	.right-scroll {
		flex: 1;
		height: 0;
	}

	.empty-state {
		padding: 30px 0;
		align-items: center;
	}

	.empty-text {
		color: #86868b;
		font-size: 15px;
	}

	.apple-btn-small {
		height: 36px;
		line-height: 36px;
		font-size: 14px;
		padding-left: 14px;
		padding-right: 14px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0,0,0,0.5);
		justify-content: center;
		align-items: center;
		z-index: 999;
		display: flex;
	}

	.modal-content {
		width: 300px;
		background-color: #ffffff;
		border-radius: 12px;
		padding: 20px;
	}

	.modal-title {
		font-size: 18px;
		font-weight: bold;
		margin-bottom: 20px;
		text-align: center;
		display: block;
	}

	.picker-input {
		height: 44px;
		background-color: #f5f5f7;
		border-radius: 8px;
		padding: 0 12px;
		line-height: 44px;
		margin-bottom: 20px;
		font-size: 14px;
	}

	.modal-actions {
		flex-direction: row;
		justify-content: space-between;
		display: flex;
	}

	.apple-btn-secondary {
		background-color: #f5f5f7;
		color: #1d1d1f;
	}

	.apple-btn-danger {
		background-color: #ff3b30;
		color: #ffffff;
	}

	.modal-desc {
		font-size: 14px;
		color: #6e6e73;
		text-align: center;
		display: block;
		margin-bottom: 12px;
	}

	.chat-header-actions {
		flex-direction: row;
		align-items: center;
	}
</style>
