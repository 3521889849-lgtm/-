<template>
	<view class="leave-approve-view">
		<text class="section-title">å®¡æ‰¹å¤„ç†</text>
		<view class="card">
			<view class="filter-bar">
				<input class="apple-input search-input" v-model="filter.keyword" placeholder="æœç´¢ç”³è¯·äºº/ç›®æ ‡äºº/åŸå› " />
				<button class="filter-btn" @click="loadList">æœç´¢</button>
			</view>

			<view class="filter-options">
				<view class="status-tabs">
					<view class="status-tab" :class="{ active: filter.approval_status === -1 }" @click="setStatus(-1)">
						<text class="status-tab-text">å…¨éƒ¨</text>
					</view>
					<view class="status-tab" :class="{ active: filter.approval_status === 0 }" @click="setStatus(0)">
						<text class="status-tab-text">å¾…å®¡æ‰¹</text>
					</view>
					<view class="status-tab" :class="{ active: filter.approval_status === 1 }" @click="setStatus(1)">
						<text class="status-tab-text">å·²é€šè¿‡</text>
					</view>
					<view class="status-tab" :class="{ active: filter.approval_status === 2 }" @click="setStatus(2)">
						<text class="status-tab-text">å·²æ‹’ç»</text>
					</view>
				</view>
				<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="loadList">åˆ·æ–°</button>
			</view>

			<view v-if="items.length === 0" class="empty-state">
				<text class="empty-text">æš‚æ— ç”³è¯·æ•°æ®</text>
			</view>

			<view class="split">
				<view class="left">
					<scroll-view scroll-y="true" class="list-scroll">
						<view v-for="it in items" :key="it.apply_id" class="list-item" :class="{ selected: selectedApplyId === it.apply_id }" @click="selectItem(it)">
							<view class="item-header">
								<text class="item-title">#{{ it.apply_id }} {{ it.cs_name || it.cs_id }}</text>
								<text class="badge" :class="badgeClass(it.approval_status)">{{ statusText(it.approval_status) }}</text>
							</view>
							<text class="item-sub">{{ applyTypeText(it.apply_type) }} Â· {{ it.target_date }} Â· {{ it.shift_name || ('ç­æ¬¡' + it.shift_id) }}</text>
							<text class="item-reason">{{ it.reason || 'ï¼ˆæ— åŸå› ï¼‰' }}</text>
						</view>
					</scroll-view>
				</view>

				<view class="right">
					<view v-if="!detail" class="empty-detail">
						<text class="empty-text">è¯·é€‰æ‹©å·¦ä¾§ç”³è¯·æŸ¥çœ‹è¯¦æƒ…</text>
					</view>

					<view v-else class="detail-card">
						<view class="detail-header">
							<text class="detail-title">ç”³è¯·è¯¦æƒ…</text>
							<button class="audit-log-btn" @click="loadAuditLog">æŸ¥çœ‹å®¡è®¡æ—¥å¿—</button>
						</view>

						<view class="kv">
							<text class="k">ç”³è¯·ID</text>
							<text class="v">#{{ detail.apply_id }}</text>
						</view>
						<view class="kv">
							<text class="k">ç”³è¯·ç±»å‹</text>
							<text class="v">{{ applyTypeText(detail.apply_type) }}</text>
						</view>
						<view class="kv">
							<text class="k">æ—¥æœŸ/ç­æ¬¡</text>
							<text class="v">{{ formatDateRange(detail) }} Â· {{ detail.shift_name || ('ç­æ¬¡' + detail.shift_id) }}</text>
						</view>
						<view class="kv">
							<text class="k">ç”³è¯·äºº</text>
							<text class="v">{{ detail.cs_name || '-' }}ï¼ˆ{{ detail.cs_id }}ï¼‰</text>
						</view>
						<view class="kv">
							<text class="k">éƒ¨é—¨/ç­ç»„</text>
							<text class="v">{{ (detail.dept_id || '-') + ' / ' + (detail.team_id || '-') }}</text>
						</view>
						<view class="kv" v-if="detail.apply_type === 1">
							<text class="k">ç›®æ ‡å®¢æœ</text>
							<text class="v">{{ detail.target_cs_name || '-' }}ï¼ˆ{{ detail.target_cs_id || '-' }}ï¼‰</text>
						</view>
						<view class="kv">
							<text class="k">ç”³è¯·åŸå› </text>
							<text class="v">{{ detail.reason || 'ï¼ˆæ— ï¼‰' }}</text>
						</view>
						<view class="kv">
							<text class="k">æäº¤æ—¶é—´</text>
							<text class="v">{{ detail.create_time || '-' }}</text>
						</view>
						<view class="kv">
							<text class="k">å®¡æ‰¹çŠ¶æ€</text>
							<text class="v">{{ statusText(detail.approval_status) }}</text>
						</view>
						<view class="kv" v-if="detail.approval_status !== 0">
							<text class="k">å®¡æ‰¹äºº</text>
							<text class="v">{{ detail.approver_name || detail.approver_id || '-' }}</text>
						</view>
						<view class="kv" v-if="detail.approval_status !== 0">
							<text class="k">å®¡æ‰¹æ—¶é—´</text>
							<text class="v">{{ detail.approval_time || '-' }}</text>
						</view>
						<view class="kv" v-if="detail.approval_status !== 0 && detail.approval_remark">
							<text class="k">å®¡æ‰¹å¤‡æ³¨</text>
							<text class="v">{{ detail.approval_remark }}</text>
						</view>

						<view class="divider"></view>

						<!-- å®¡è®¡æ—¥å¿—å±•ç¤ºåŒºåŸŸ -->
						<view v-if="auditLogs.length > 0" class="audit-log-section">
							<text class="detail-title">å®¡è®¡æ—¥å¿—</text>
							<view class="audit-timeline">
								<view v-for="(log, idx) in auditLogs" :key="idx" class="audit-item">
									<view class="audit-dot" :class="getAuditDotClass(log.action)"></view>
									<view class="audit-content">
										<view class="audit-header">
											<text class="audit-action">{{ getAuditActionText(log.action) }}</text>
											<text class="audit-time">{{ log.create_time }}</text>
										</view>
										<text class="audit-operator">æ“ä½œäºº: {{ log.operator_name || log.operator_id }}</text>
										<text v-if="log.remark" class="audit-remark">å¤‡æ³¨: {{ log.remark }}</text>
										<text v-if="log.details" class="audit-details">{{ log.details }}</text>
									</view>
								</view>
							</view>
						</view>

						<view class="divider"></view>

						<text class="detail-title">æ‰§è¡Œå®¡æ‰¹</text>
						<view class="field">
							<text class="form-label">å®¡æ‰¹å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
							<input class="apple-input" v-model="approve.approval_remark" placeholder="å¡«å†™å®¡æ‰¹æ„è§æˆ–å¤‡æ³¨" />
						</view>
						<view class="field">
							<text class="form-label">å®¡æ‰¹ç»“æœ</text>
							<view class="approve-actions">
								<button class="approve-btn pass" :class="{ selected: approveStatusIndex === 0 }" @click="setApproveStatus(0)">é€šè¿‡</button>
								<button class="approve-btn reject" :class="{ selected: approveStatusIndex === 1 }" @click="setApproveStatus(1)">æ‹’ç»</button>
							</view>
						</view>
						<button class="apple-btn" style="background-color: #34c759;" :disabled="detail.approval_status !== 0" @click="submitApprove">
							{{ detail.approval_status === 0 ? 'æäº¤å®¡æ‰¹' : 'å·²å®¡æ‰¹' }}
						</button>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import { api } from '../../common/api.js'
	import { ensureOk } from '../../common/request.js'

	export default {
		data() {
			return {
				filter: {
					approval_status: 0,
					keyword: ''
				},
				items: [],
				selectedApplyId: 0,
				detail: null,
				approveStatusIndex: 0,
				approve: {
					approval_remark: ''
				},
				auditLogs: [] // å®¡è®¡æ—¥å¿—æ•°æ®
			}
		},
		mounted() {
			this.loadList()
		},
		methods: {
			statusText(s) {
				if (s === 0) return 'å¾…å®¡æ‰¹'
				if (s === 1) return 'å·²é€šè¿‡'
				if (s === 2) return 'å·²æ‹’ç»'
				return 'æœªçŸ¥'
			},
			badgeClass(s) {
				if (s === 0) return 'badge-pending'
				if (s === 1) return 'badge-pass'
				if (s === 2) return 'badge-reject'
				return 'badge-unknown'
			},
			applyTypeText(t) {
				return t === 1 ? 'è°ƒç­' : 'è¯·å‡'
			},
			setStatus(s) {
				this.filter.approval_status = s
				this.selectedApplyId = 0
				this.detail = null
				this.loadList()
			},
			setApproveStatus(index) {
				this.approveStatusIndex = index
			},
			// æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´æ˜¾ç¤º
			formatDateRange(item) {
				if (!item) return '-'
				// å¦‚æœæœ‰start_dateå’Œend_dateï¼Œæ˜¾ç¤ºèŒƒå›´
				if (item.start_date && item.end_date) {
					const periodText = (p) => {
						if (p === 0) return 'å…¨å¤©'
						if (p === 1) return 'ä¸Šåˆ'
						if (p === 2) return 'ä¸‹åˆ'
						return ''
					}
					if (item.start_date === item.end_date) {
						// åŒä¸€å¤©
						if (item.start_period === 0) {
							return item.start_date + ' å…¨å¤©'
						}
						return item.start_date + ' ' + periodText(item.start_period)
					}
					// ä¸åŒå¤©
					return item.start_date + periodText(item.start_period) + ' ~ ' + item.end_date + periodText(item.end_period)
				}
				// å…¼å®¹æ—§æ•°æ®ï¼šåªæœ‰target_date
				return item.target_date || '-'
			},
			async loadList() {
				try {
					uni.showLoading({ title: 'åŠ è½½ä¸­' })
					const res = await api.listLeaveTransfer({
						approval_status: this.filter.approval_status,
						keyword: (this.filter.keyword || '').trim(),
						page: 1,
						page_size: 50
					})
					uni.hideLoading()
					ensureOk(res)
					this.items = res.items || []
					if (this.selectedApplyId > 0) {
						const hit = this.items.find(x => x.apply_id === this.selectedApplyId)
						if (!hit) {
							this.selectedApplyId = 0
							this.detail = null
						}
					}
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'åŠ è½½å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			},
			async selectItem(it) {
				if (!it || !it.apply_id) return
				this.selectedApplyId = it.apply_id
				this.detail = null
				this.auditLogs = [] // æ¸…ç©ºå®¡è®¡æ—¥å¿—

				try {
					uni.showLoading({ title: 'åŠ è½½è¯¦æƒ…' })
					const res = await api.getLeaveTransfer(it.apply_id)
					uni.hideLoading()
					ensureOk(res)
					this.detail = res.item || null
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'è·å–è¯¦æƒ…å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			},
			// åŠ è½½å®¡è®¡æ—¥å¿—
			async loadAuditLog() {
				if (!this.detail || !this.detail.apply_id) {
					uni.showToast({ title: 'è¯·å…ˆé€‰æ‹©ç”³è¯·', icon: 'none' })
					return
				}

				try {
					uni.showLoading({ title: 'åŠ è½½ä¸­' })
					const res = await api.getLeaveAuditLog(this.detail.apply_id)
					uni.hideLoading()
					ensureOk(res)
					this.auditLogs = res.logs || []
					if (this.auditLogs.length === 0) {
						uni.showToast({ title: 'æš‚æ— å®¡è®¡æ—¥å¿—', icon: 'none' })
					} else {
						uni.showToast({ title: `åŠ è½½äº† ${this.auditLogs.length} æ¡è®°å½•` })
					}
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			},
			// è·å–å®¡è®¡åŠ¨ä½œæ–‡æœ¬
			getAuditActionText(action) {
				const map = {
					'CREATE': 'ğŸ“ åˆ›å»ºç”³è¯·',
					'SUBMIT': 'ğŸš€ æäº¤ç”³è¯·',
					'APPROVE': 'âœ… å®¡æ‰¹é€šè¿‡',
					'REJECT': 'âŒ å®¡æ‰¹æ‹’ç»',
					'CANCEL': 'ğŸš« å–æ¶ˆç”³è¯·',
					'UPDATE': 'âœï¸ ä¿®æ”¹ç”³è¯·'
				}
				return map[action] || action
			},
			// è·å–å®¡è®¡ç‚¹æ ·å¼
			getAuditDotClass(action) {
				if (action === 'APPROVE') return 'dot-success'
				if (action === 'REJECT') return 'dot-error'
				if (action === 'CANCEL') return 'dot-warning'
				return 'dot-default'
			},
			async submitApprove() {
				if (!this.detail || !this.detail.apply_id) {
					uni.showToast({ title: 'è¯·å…ˆé€‰æ‹©ç”³è¯·', icon: 'none' })
					return
				}
				if (this.detail.approval_status !== 0) {
					uni.showToast({ title: 'è¯¥ç”³è¯·å·²å®¡æ‰¹', icon: 'none' })
					return
				}

				const approvalRemark = (this.approve.approval_remark || '').trim()
				const status = this.approveStatusIndex + 1

				try {
					uni.showLoading({ title: 'å¤„ç†ä¸­' })
					// åç«¯ä¼šè‡ªåŠ¨ä» token è·å–å®¡æ‰¹äººä¿¡æ¯
					const res = await api.approveLeaveTransfer({
						apply_id: this.detail.apply_id,
						approval_status: status,
						approval_remark: approvalRemark
					})
					uni.hideLoading()

					if (res.base_resp && res.base_resp.code === 409) {
						uni.showModal({
							title: 'å®¡æ‰¹å¤±è´¥',
							content: 'æ’ç­å†²çªï¼š' + res.base_resp.msg,
							showCancel: false
						})
						return
					}

					ensureOk(res)
					uni.showToast({ title: 'å®¡æ‰¹æˆåŠŸ' })

					await this.selectItem({ apply_id: this.detail.apply_id })
					await this.loadList()
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'å®¡æ‰¹å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			}
		}
	}
</script>

<style>
	.filter-bar {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
	}

	.search-input {
		flex: 1;
		margin-right: 10px;
	}

	.filter-btn {
		height: 44px;
		line-height: 44px;
		padding: 0 16px;
		background-color: #0071e3;
		color: #ffffff;
		border-radius: 12px;
		font-size: 14px;
		font-weight: 500;
	}

	.filter-options {
		margin-top: 12px;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
	}

	.status-tabs {
		flex-direction: row;
		align-items: center;
	}

	.status-tab {
		height: 32px;
		padding: 0 12px;
		border-radius: 10px;
		background-color: #f5f5f7;
		justify-content: center;
		margin-right: 8px;
	}

	.status-tab.active {
		background-color: #e8f3ff;
	}

	.status-tab-text {
		font-size: 13px;
		color: #1d1d1f;
	}

	.split {
		margin-top: 16px;
		flex-direction: row;
		height: 520px;
	}

	.left {
		width: 48%;
		border-right: 1px solid #ebedf0;
		padding-right: 12px;
	}

	.right {
		width: 52%;
		padding-left: 12px;
	}

	.list-scroll {
		height: 520px;
	}

	.list-item {
		padding: 12px;
		border-radius: 12px;
		background-color: #ffffff;
		border: 1px solid #f0f0f0;
		margin-bottom: 10px;
		cursor: pointer;
	}

	.list-item.selected {
		border-color: #0071e3;
		background-color: #f5faff;
	}

	.item-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
	}

	.item-title {
		font-size: 15px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.item-sub {
		margin-top: 6px;
		font-size: 13px;
		color: #6b7280;
	}

	.item-reason {
		margin-top: 8px;
		font-size: 13px;
		color: #1d1d1f;
	}

	.badge {
		height: 22px;
		line-height: 22px;
		padding: 0 10px;
		border-radius: 11px;
		font-size: 12px;
		color: #ffffff;
	}

	.badge-pending {
		background-color: #86909c;
	}

	.badge-pass {
		background-color: #34c759;
	}

	.badge-reject {
		background-color: #ff3b30;
	}

	.badge-unknown {
		background-color: #111827;
	}

	.detail-card {
		background-color: #ffffff;
		border: 1px solid #f0f0f0;
		border-radius: 12px;
		padding: 14px;
	}

	.detail-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 10px;
	}

	.audit-log-btn {
		height: 32px;
		line-height: 32px;
		padding: 0 12px;
		background-color: #f5f5f7;
		color: #0071e3;
		border-radius: 8px;
		font-size: 13px;
		font-weight: 500;
	}

	.audit-log-btn:active {
		background-color: #e5e5e7;
	}

	/* å®¡è®¡æ—¥å¿—åŒºåŸŸ */
	.audit-log-section {
		margin-top: 12px;
	}

	.audit-timeline {
		padding-left: 12px;
		margin-top: 10px;
	}

	.audit-item {
		flex-direction: row;
		margin-bottom: 16px;
		position: relative;
	}

	.audit-item:last-child {
		margin-bottom: 0;
	}

	.audit-dot {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		margin-right: 10px;
		margin-top: 4px;
		flex-shrink: 0;
	}

	.dot-default {
		background-color: #86868b;
	}

	.dot-success {
		background-color: #34c759;
		box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.1);
	}

	.dot-error {
		background-color: #ff3b30;
		box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.1);
	}

	.dot-warning {
		background-color: #ffcc00;
		box-shadow: 0 0 0 4px rgba(255, 204, 0, 0.1);
	}

	.audit-content {
		flex: 1;
		background-color: #f8f9fa;
		border-radius: 8px;
		padding: 10px;
	}

	.audit-header {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 6px;
	}

	.audit-action {
		font-size: 14px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.audit-time {
		font-size: 12px;
		color: #86868b;
	}

	.audit-operator {
		font-size: 13px;
		color: #6b7280;
		margin-bottom: 4px;
	}

	.audit-remark {
		font-size: 13px;
		color: #1d1d1f;
		margin-top: 4px;
		line-height: 18px;
	}

	.audit-details {
		font-size: 12px;
		color: #86868b;
		margin-top: 4px;
		line-height: 16px;
	}

	.kv {
		flex-direction: row;
		justify-content: space-between;
		margin-bottom: 8px;
	}

	.k {
		font-size: 13px;
		color: #6b7280;
	}

	.v {
		font-size: 13px;
		color: #1d1d1f;
		max-width: 70%;
		text-align: right;
	}

	.divider {
		height: 1px;
		background-color: #ebedf0;
		margin: 12px 0;
	}

	.empty-detail {
		height: 520px;
		align-items: center;
		justify-content: center;
	}

	.empty-state {
		margin-top: 20px;
		align-items: center;
		justify-content: center;
	}

	.empty-text {
		color: #86868b;
		font-size: 13px;
	}

	.field {
		margin-bottom: 14px;
	}

	.approve-actions {
		flex-direction: row;
		justify-content: space-between;
	}

	.approve-btn {
		flex: 1;
		height: 44px;
		line-height: 44px;
		text-align: center;
		border-radius: 12px;
		font-size: 15px;
		font-weight: 500;
		border: 1px solid transparent;
		margin: 0 4px;
	}

	.approve-btn.pass {
		background-color: #f5f5f7;
		color: #34c759;
	}

	.approve-btn.pass.selected {
		background-color: #e8f9ec;
		border-color: #34c759;
		font-weight: 600;
	}

	.approve-btn.reject {
		background-color: #f5f5f7;
		color: #ff3b30;
	}

	.approve-btn.reject.selected {
		background-color: #ffebe9;
		border-color: #ff3b30;
		font-weight: 600;
	}
</style>
