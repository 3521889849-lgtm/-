<template>
	<view class="schedule-view">
		<text class="section-title">æ’ç­ç®¡ç†</text>

		<view class="card" style="margin-top: 12px;">
			<view class="segmented-control">
				<view class="segment-item" :class="{ active: viewMode === 'assign' }" @click="setViewMode('assign')">
					<text class="segment-text" :class="{ 'active-text': viewMode === 'assign' }">åˆ†é…</text>
				</view>
				<view class="segment-item" :class="{ active: viewMode === 'grid' }" @click="setViewMode('grid')">
					<text class="segment-text" :class="{ 'active-text': viewMode === 'grid' }">è¡¨æ ¼</text>
				</view>
			</view>
		</view>

		<view v-if="viewMode === 'grid'" class="card" style="margin-top: 16px;">
			<view class="form-group">
				<view class="grid-toolbar">
					<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="shiftGridRange(-7)">ä¸Šä¸€å‘¨</button>
					<text class="grid-range">{{ gridStartDate }} ~ {{ gridEndDate }}</text>
					<view class="grid-toolbar-right">
						<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="handleAutoSchedule">è‡ªåŠ¨æ’ç­</button>
						<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="exportGridExcel">å¯¼å‡ºExcel</button>
						<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="shiftGridRange(7)">ä¸‹ä¸€å‘¨</button>
					</view>
				</view>
				<view class="grid-toolbar" style="margin-top: 10px;">
					<input class="apple-input grid-filter" v-model="gridCustomerKeyword" placeholder="ç­›é€‰å®¢æœå§“å/ID" />
					<button class="apple-btn apple-btn-small" hover-class="apple-btn-hover" @click="reloadGrid">åˆ·æ–°</button>
				</view>
			</view>

			<scroll-view scroll-x="true" class="grid-scroll">
				<view class="grid-table">
					<view class="grid-row grid-header">
						<view class="grid-cell grid-sticky grid-name">å®¢æœ</view>
						<view v-for="d in gridDates" :key="d" class="grid-cell grid-date">
							<text class="grid-date-text">{{ d.substring(5) }}</text>
						</view>
					</view>

					<view v-for="c in gridFilteredCustomers" :key="c.cs_id" class="grid-row">
						<view class="grid-cell grid-sticky grid-name">
							<view class="grid-name-wrapper">
								<text class="grid-cs-name">{{ c.cs_name }}</text>
								<!-- åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ - 4ç§çŠ¶æ€ -->
								<view 
									class="online-indicator" 
									:class="getStatusClass(c.cs_id)"
									@click="showStatusDetail(c.cs_id)"
									:title="getStatusTooltip(c.cs_id)"
								></view>
							</view>
							<text class="grid-cs-id">{{ c.cs_id }}</text>
						</view>
						<view
							v-for="d in gridDates"
							:key="c.cs_id + '_' + d"
							class="grid-cell grid-slot"
							:class="{ 
								'grid-slot-warn': isMinStaffWarn(d, getCellShiftId(c.cs_id, d)),
								'grid-slot-filled': getCellShiftId(c.cs_id, d) > 0,
								'grid-slot-holiday': isHolidayShift(getCellShiftId(c.cs_id, d))
							}"
							@click="openCellAction(c.cs_id, d)"
						>
							<text class="grid-slot-text">{{ getCellText(c.cs_id, d) }}</text>
						</view>
					</view>
				</view>
			</scroll-view>
		</view>

		<view v-if="viewMode === 'assign'">
		<view class="card">
			<view class="form-group">
				<view class="field">
					<text class="form-label">æ’ç­æ—¥æœŸ</text>
					<picker mode="date" :value="scheduleDate" @change="onDateChange">
						<view class="apple-input picker-text">{{ scheduleDate || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</view>
					</picker>
				</view>

				<view class="field">
					<text class="form-label">é€‰æ‹©ç­æ¬¡</text>
					<picker mode="selector" :range="shiftNames" :value="selectedShiftIndex" @change="onShiftChange">
						<view class="apple-input picker-text">{{ currentShiftName || 'è¯·é€‰æ‹©ç­æ¬¡' }}</view>
					</picker>
					<text v-if="currentShiftMinStaffText" :class="minStaffClass">{{ currentShiftMinStaffText }}</text>
				</view>
			</view>
		</view>

		<text class="section-title" style="margin-top: 40px; font-size: 20px;">äººå‘˜åˆ†é…</text>
		<view class="card">
			<view class="filter-bar">
				<input class="apple-input search-input" v-model="customerKeyword" placeholder="æœç´¢å§“å/ID/æŠ€èƒ½" />
			</view>
			
			<view class="customer-list">
				<checkbox-group @change="onCustomerChange">
					<view v-for="c in filteredCustomers" :key="c.cs_id" class="customer-item">
						<label class="customer-label">
							<view class="checkbox-wrapper">
								<checkbox color="#0071e3" :value="c.cs_id" :checked="selectedCsIdSet[c.cs_id] === true"></checkbox>
							</view>
							<view class="customer-info">
								<text class="customer-name">{{ c.cs_name }} <text class="customer-id">({{ c.cs_id }})</text></text>
								<text class="customer-skill">{{ c.skill_tags }}</text>
							</view>
						</label>
					</view>
				</checkbox-group>
			</view>
			
			<view v-if="filteredCustomers.length === 0" class="empty-state">
				<text class="empty-text">æœªæ‰¾åˆ°åŒ¹é…çš„å®¢æœäººå‘˜</text>
			</view>
		</view>

		<view class="action-bar">
			<button class="apple-btn" @click="submit">æäº¤æ’ç­</button>
		</view>
		</view>
	</view>
</template>

<script>
	import { api } from '../../common/api.js'
	import { ensureOk } from '../../common/request.js'

	function todayYMD() {
		const d = new Date()
		const y = d.getFullYear()
		const m = String(d.getMonth() + 1).padStart(2, '0')
		const dd = String(d.getDate()).padStart(2, '0')
		return `${y}-${m}-${dd}`
	}

	function getHeader(headers, name) {
		if (!headers) return ''
		const keys = Object.keys(headers)
		const target = String(name || '').toLowerCase()
		for (let i = 0; i < keys.length; i++) {
			const k = keys[i]
			if (String(k).toLowerCase() === target) {
				return headers[k] || ''
			}
		}
		return ''
	}

	function parseFileName(disposition, fallbackName) {
		const v = String(disposition || '')
		if (!v) return fallbackName
		const m1 = v.match(/filename\\*=UTF-8''([^;]+)/i)
		if (m1 && m1[1]) {
			try {
				return decodeURIComponent(m1[1].trim())
			} catch (e) {
				return m1[1].trim()
			}
		}
		const m2 = v.match(/filename=\"([^\"]+)\"/i)
		if (m2 && m2[1]) return m2[1]
		const m3 = v.match(/filename=([^;]+)/i)
		if (m3 && m3[1]) return String(m3[1]).trim()
		return fallbackName
	}

	function arrayBufferToText(buf) {
		try {
			if (typeof TextDecoder !== 'undefined') {
				return new TextDecoder('utf-8').decode(new Uint8Array(buf))
			}
		} catch (e) {}
		try {
			let s = ''
			const bytes = new Uint8Array(buf)
			for (let i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i])
			return decodeURIComponent(escape(s))
		} catch (e) {}
		return ''
	}

	export default {
		data() {
			return {
				viewMode: 'grid',
				scheduleDate: '',
				shifts: [],
				selectedShiftIndex: -1,
				customers: [],
				customerKeyword: '',
				selectedCsIds: [],
				selectedCsIdSet: {},

				gridStartDate: '',
				gridEndDate: '',
				gridDates: [],
				gridCustomers: [],
				gridShifts: [],
				gridCells: [],
				gridCellMap: {},
				gridShiftNameMap: {},
				gridShiftMinStaffMap: {},
				gridDateShiftCount: {},
				gridCustomerKeyword: '',
				// åœ¨çº¿çŠ¶æ€è¿½è¸ª
				onlineCustomers: {}, // åœ¨çº¿å®¢æœè¯¦æƒ…æ˜ å°„ { cs_id: { is_online: 0-3, last_seen_at, login_at, current_shift } }
				heartbeatTimer: null // å¿ƒè·³å®šæ—¶å™¨
			}
		},
		computed: {
			shiftNames() {
				return this.shifts.map((s) => `${s.shift_name} (${s.start_time.substring(0,5)}-${s.end_time.substring(0,5)})`)
			},
			currentShift() {
				if (this.selectedShiftIndex < 0) return null
				return this.shifts[this.selectedShiftIndex] || null
			},
			currentShiftName() {
				const s = this.currentShift
				return s ? `${s.shift_name} (${s.start_time.substring(0,5)}-${s.end_time.substring(0,5)})` : ''
			},
			currentShiftMinStaffText() {
				const s = this.currentShift
				if (!s) return ''
				const sel = this.selectedCsIds.length
				if (s.min_staff <= 0) return ''
				if (sel < s.min_staff) {
					return `éœ€è¡¥å‘˜ï¼šå½“å‰ ${sel} äººï¼Œæœ€å°‘ ${s.min_staff} äºº`
				}
				return `å·²è¾¾æ ‡ï¼šå½“å‰ ${sel} äººï¼Œæœ€å°‘ ${s.min_staff} äºº`
			},
			minStaffClass() {
				const s = this.currentShift
				if (!s || s.min_staff <= 0) return 'hint-text'
				return this.selectedCsIds.length < s.min_staff ? 'warn-text' : 'success-text'
			},
			filteredCustomers() {
				const kw = (this.customerKeyword || '').trim().toLowerCase()
				if (!kw) return this.customers
				return this.customers.filter((c) => {
					return (
						String(c.cs_id || '').toLowerCase().includes(kw) ||
						String(c.cs_name || '').toLowerCase().includes(kw) ||
						String(c.skill_tags || '').toLowerCase().includes(kw)
					)
				})
			},
			gridFilteredCustomers() {
				const kw = (this.gridCustomerKeyword || '').trim().toLowerCase()
				if (!kw) return this.gridCustomers
				return this.gridCustomers.filter((c) => {
					return (
						String(c.cs_id || '').toLowerCase().includes(kw) ||
						String(c.cs_name || '').toLowerCase().includes(kw)
					)
				})
			}
		},
		mounted() {
			this.scheduleDate = todayYMD()
			this.initGridRange()
			this.loadInit()
			this.loadOnlineStatus()
			this.startHeartbeat()
		},
		beforeUnmount() {
			this.stopHeartbeat()
		},
		methods: {
			// è·å–å®¢æœåœ¨çº¿çŠ¶æ€ï¼ˆ0-3ï¼‰
			getCustomerOnlineStatus(csId) {
				const info = this.onlineCustomers[csId]
				if (!info) return 3 // é»˜è®¤ç¦»çº¿
				return info.is_online || 3
			},
			// è·å–çŠ¶æ€æç¤ºæ–‡æœ¬
			getStatusTooltip(csId) {
				const info = this.onlineCustomers[csId]
				if (!info) return 'ç¦»çº¿'
				const statusText = ['ğŸŸ¢åœ¨çº¿', 'ğŸŸ¡åœ¨çº¿éç­æ¬¡', 'ğŸ”´å¼‚å¸¸ç¦»çº¿', 'âšªç¦»çº¿'][info.is_online] || 'âšªç¦»çº¿'
				let detail = statusText
				if (info.last_seen_at) {
					detail += `\næœ€åå¿ƒè·³: ${info.last_seen_at}`
				}
				if (info.login_at) {
					detail += `\nç™»å½•æ—¶é—´: ${info.login_at}`
				}
				if (info.current_shift) {
					detail += `\nå½“å‰ç­æ¬¡: ${info.current_shift}`
				}
				return detail
			},
			// åŠ è½½åœ¨çº¿çŠ¶æ€æ•°æ®
			async loadOnlineStatus() {
				try {
					const res = await api.listOnlineCustomers({
						date: todayYMD()
					})
					ensureOk(res)
					const map = {}
					;(res.customers || []).forEach((c) => {
						map[c.cs_id] = {
							is_online: c.is_online || 3,
							last_seen_at: c.last_seen_at || '',
							login_at: c.login_at || '',
							current_shift: c.current_shift || ''
						}
					})
					this.onlineCustomers = map
				} catch (e) {
					console.error('åŠ è½½åœ¨çº¿çŠ¶æ€å¤±è´¥:', e)
					this.onlineCustomers = {}
				}
			},
			// å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨
			startHeartbeat() {
				if (this.heartbeatTimer) {
					clearInterval(this.heartbeatTimer)
				}
				// æ¯30ç§’åˆ·æ–°ä¸€æ¬¡åœ¨çº¿çŠ¶æ€
				this.heartbeatTimer = setInterval(() => {
					this.loadOnlineStatus()
				}, 30000)
			},
			// åœæ­¢å¿ƒè·³å®šæ—¶å™¨
			stopHeartbeat() {
				if (this.heartbeatTimer) {
					clearInterval(this.heartbeatTimer)
					this.heartbeatTimer = null
				}
			},
			setViewMode(mode) {
				this.viewMode = mode
				if (mode === 'grid') {
					this.reloadGrid()
					this.loadOnlineStatus()
				}
			},
			// è·å–çŠ¶æ€æ ·å¼ç±»å
			getStatusClass(csId) {
				const status = this.getCustomerOnlineStatus(csId)
				const classMap = {
					0: 'status-online',        // ğŸŸ¢åœ¨çº¿
					1: 'status-online-off',    // ğŸŸ¡åœ¨çº¿éç­æ¬¡
					2: 'status-abnormal',      // ğŸ”´å¼‚å¸¸ç¦»çº¿
					3: 'status-offline'        // âšªç¦»çº¿
				}
				return classMap[status] || 'status-offline'
			},
			// æ˜¾ç¤ºçŠ¶æ€è¯¦æƒ…
			showStatusDetail(csId) {
				const tooltip = this.getStatusTooltip(csId)
				uni.showModal({
					title: 'åœ¨çº¿çŠ¶æ€è¯¦æƒ…',
					content: tooltip,
					showCancel: false
				})
			},
			initGridRange() {
				const today = new Date()
				const day = today.getDay()
				const diff = (day === 0 ? -6 : 1) - day
				const start = new Date(today)
				start.setDate(today.getDate() + diff)
				const end = new Date(start)
				end.setDate(start.getDate() + 13)
				this.gridStartDate = this.formatYMD(start)
				this.gridEndDate = this.formatYMD(end)
			},
			formatYMD(d) {
				const y = d.getFullYear()
				const m = String(d.getMonth() + 1).padStart(2, '0')
				const dd = String(d.getDate()).padStart(2, '0')
				return `${y}-${m}-${dd}`
			},
			setGridRangeByDate(ymd) {
				const d = new Date(ymd + 'T00:00:00')
				if (Number.isNaN(d.getTime())) return
				const day = d.getDay()
				const diff = (day === 0 ? -6 : 1) - day
				const start = new Date(d)
				start.setDate(d.getDate() + diff)
				const end = new Date(start)
				end.setDate(start.getDate() + 13)
				this.gridStartDate = this.formatYMD(start)
				this.gridEndDate = this.formatYMD(end)
			},
			shiftGridRange(days) {
				const st = new Date(this.gridStartDate + 'T00:00:00')
				const et = new Date(this.gridEndDate + 'T00:00:00')
				st.setDate(st.getDate() + days)
				et.setDate(et.getDate() + days)
				this.gridStartDate = this.formatYMD(st)
				this.gridEndDate = this.formatYMD(et)
				this.reloadGrid()
			},
			async reloadGrid() {
				try {
					uni.showLoading({ title: 'åŠ è½½ä¸­' })
					const res = await api.listScheduleGrid({
						start_date: this.gridStartDate,
						end_date: this.gridEndDate
					})
					uni.hideLoading()
					ensureOk(res)
					this.gridDates = res.dates || []
					this.gridCustomers = res.customers || []
					this.gridShifts = res.shifts || []
					this.gridCells = res.cells || []
					this.buildGridMaps()
				} catch (e) {
					uni.hideLoading()
					this.gridDates = []
					this.gridCustomers = []
					this.gridShifts = []
					this.gridCells = []
					this.gridCellMap = {}
					this.gridShiftNameMap = {}
					this.gridShiftMinStaffMap = {}
					this.gridDateShiftCount = {}
					console.error(e)
				}
			},
			async handleAutoSchedule() {
				const start = this.gridStartDate
				const end = this.gridEndDate
				uni.showModal({
					title: 'è‡ªåŠ¨æ’ç­',
					content: `ç¡®å®šè¦ä¸º ${start} è‡³ ${end} è¿›è¡Œè‡ªåŠ¨æ’ç­å—ï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæœªæ’ç­çš„å®¢æœåˆ†é…ç­æ¬¡ã€‚`,
					success: async (res) => {
						if (res.confirm) {
							try {
								uni.showLoading({ title: 'æ’ç­ä¸­...' })
								const resp = await api.autoSchedule({
									start_date: start,
									end_date: end
								})
								uni.hideLoading()
								ensureOk(resp)
								uni.showToast({ title: 'è‡ªåŠ¨æ’ç­æˆåŠŸ' })
								this.reloadGrid()
							} catch (e) {
								uni.hideLoading()
								uni.showModal({
									title: 'æ’ç­å¤±è´¥',
									content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
									showCancel: false
								})
							}
						}
					}
				})
			},
			async exportGridExcel() {
				const start = this.gridStartDate
				const end = this.gridEndDate
				if (!start || !end) {
					uni.showToast({ title: 'æ—¥æœŸèŒƒå›´ä¸ºç©º', icon: 'none' })
					return
				}

				try {
					uni.showLoading({ title: 'å¯¼å‡ºä¸­' })
					const res = await api.exportScheduleExcel({
						start_date: start,
						end_date: end
					})
					uni.hideLoading()

					const headers = (res && (res.header || res.headers)) || {}
					const contentType = getHeader(headers, 'content-type')
					if (contentType && String(contentType).toLowerCase().includes('application/json')) {
						const text = arrayBufferToText(res.data)
						let msg = text || 'å¯¼å‡ºå¤±è´¥'
						try {
							const body = JSON.parse(text)
							msg = body.msg || msg
						} catch (e) {}
						uni.showModal({ title: 'å¯¼å‡ºå¤±è´¥', content: msg, showCancel: false })
						return
					}

					const fallbackName = `schedule_${start}_${end}.xlsx`
					const fileName = parseFileName(getHeader(headers, 'content-disposition'), fallbackName)

					// #ifdef H5
					const blob = new Blob([res.data], {
						type: contentType || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
					})
					const url = window.URL.createObjectURL(blob)
					const a = document.createElement('a')
					a.href = url
					a.download = fileName
					document.body.appendChild(a)
					a.click()
					document.body.removeChild(a)
					window.URL.revokeObjectURL(url)
					uni.showToast({ title: 'å·²å¼€å§‹ä¸‹è½½' })
					// #endif

					// #ifndef H5
					uni.showModal({ title: 'æç¤º', content: 'å½“å‰ç¯å¢ƒä¸æ”¯æŒæµè§ˆå™¨ä¸‹è½½', showCancel: false })
					// #endif
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'å¯¼å‡ºå¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			},
			buildGridMaps() {
				const cellMap = {}
				const dateShiftCount = {}
				;(this.gridCells || []).forEach((c) => {
					const csId = c.cs_id
					const d = c.schedule_date
					const key = csId + '_' + d
					cellMap[key] = c

					if (c.status === 0 && c.shift_id > 0) {
						const k2 = d + '_' + c.shift_id
						dateShiftCount[k2] = (dateShiftCount[k2] || 0) + 1
					}
				})
				const shiftNameMap = {}
				const shiftMinStaffMap = {}
				;(this.gridShifts || []).forEach((s) => {
					shiftNameMap[String(s.shift_id)] = s.shift_name
					shiftMinStaffMap[String(s.shift_id)] = s.min_staff || 0
				})
				this.gridCellMap = cellMap
				this.gridShiftNameMap = shiftNameMap
				this.gridShiftMinStaffMap = shiftMinStaffMap
				this.gridDateShiftCount = dateShiftCount
			},
			getCellShiftId(csId, date) {
				const c = this.gridCellMap[csId + '_' + date]
				return c && c.shift_id ? c.shift_id : 0
			},
			isHolidayShift(shiftId) {
				if (!shiftId || shiftId <= 0) return false
				const s = (this.gridShifts || []).find((x) => x.shift_id === shiftId)
				return s && s.is_holiday === 1
			},
			getCellText(csId, date) {
				const c = this.gridCellMap[csId + '_' + date]
				if (!c || !c.shift_id) return ''
				const name = this.gridShiftNameMap[String(c.shift_id)] || ''
				return name ? name.substring(0, 2) : String(c.shift_id)
			},
			isMinStaffWarn(date, shiftId) {
				if (!shiftId || shiftId <= 0) return false
				const min = this.gridShiftMinStaffMap[String(shiftId)] || 0
				if (min <= 0) return false
				const count = this.gridDateShiftCount[date + '_' + shiftId] || 0
				return count < min
			},
			openCellAction(csId, date) {
				const items = []
				items.push('æ¸…ç©º')
				;(this.gridShifts || []).forEach((s) => {
					items.push(s.shift_name)
				})
				uni.showActionSheet({
					itemList: items,
					success: async (res) => {
						const idx = res.tapIndex
						if (idx === 0) {
							// æ¸…ç©ºæ“ä½œå¢åŠ ç¡®è®¤é€»è¾‘
							uni.showModal({
								title: 'ç¡®è®¤æ¸…ç©º',
								content: 'ç¡®å®šè¦æ¸…ç©ºè¯¥å®¢æœåœ¨è¯¥æ—¥æœŸçš„æ’ç­å—ï¼Ÿ',
								success: async (modalRes) => {
									if (modalRes.confirm) {
										await this.saveCell(csId, date, 0)
									}
								}
							})
							return
						}
						const s = this.gridShifts[idx - 1]
						if (!s) return
						await this.saveCell(csId, date, s.shift_id)
					}
				})
			},
			async saveCell(csId, date, shiftId) {
				try {
					uni.showLoading({ title: 'ä¿å­˜ä¸­' })
					const res = await api.upsertScheduleCell({
						cs_id: csId,
						schedule_date: date,
						shift_id: shiftId,
						operator_id: 'ADMIN'
					})
					uni.hideLoading()
					ensureOk(res)
					await this.reloadGrid()
					uni.showToast({ title: 'å·²ä¿å­˜' })
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'ä¿å­˜å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			},
			onDateChange(e) {
				this.scheduleDate = e.detail.value
			},
			onShiftChange(e) {
				this.selectedShiftIndex = parseInt(e.detail.value, 10)
			},
			onCustomerChange(e) {
				const values = e.detail.value || []
				this.selectedCsIds = values
				const set = {}
				values.forEach((id) => (set[id] = true))
				this.selectedCsIdSet = set
			},
			async loadInit() {
				await Promise.all([this.loadShifts(), this.loadCustomers()])
				if (this.viewMode === 'grid') {
					this.reloadGrid()
				}
			},
			async loadShifts() {
				try {
					const res = await api.listShiftConfig({})
					ensureOk(res)
					this.shifts = res.shifts || []
					if (this.shifts.length > 0 && this.selectedShiftIndex < 0) {
						this.selectedShiftIndex = 0
					}
				} catch (e) {
					this.shifts = []
					console.error(e)
				}
			},
			async loadCustomers() {
				try {
					const res = await api.listCustomerService({ page: 1, page_size: 1000 })
					ensureOk(res)
					this.customers = res.customer_services || []
				} catch (e) {
					this.customers = []
					console.error(e)
				}
			},
			async submit() {
				if (!this.scheduleDate) {
					uni.showToast({ title: 'è¯·é€‰æ‹©æ—¥æœŸ', icon: 'none' })
					return
				}
				if (!this.currentShift) {
					uni.showToast({ title: 'è¯·é€‰æ‹©ç­æ¬¡', icon: 'none' })
					return
				}
				if (this.selectedCsIds.length === 0) {
					uni.showToast({ title: 'è¯·è‡³å°‘é€‰æ‹©ä¸€åå®¢æœ', icon: 'none' })
					return
				}

				try {
					uni.showLoading({ title: 'æäº¤ä¸­' })
					const res = await api.assignSchedule({
						schedule_date: this.scheduleDate,
						shift_id: this.currentShift.shift_id,
						cs_ids: this.selectedCsIds,
						create_by: 'ADMIN' // æš‚å®š
					})
					uni.hideLoading()
					
					// å†²çªå¤„ç†ï¼ˆæ ¹æ®åç«¯è¿”å›ç»“æ„ï¼‰
					if (res.conflict_cs_ids && res.conflict_cs_ids.length > 0) {
						uni.showModal({
							title: 'æ’ç­å†²çª',
							content: `ä»¥ä¸‹å®¢æœåœ¨è¯¥æ—¥æœŸå·²æœ‰ç­æ¬¡ï¼š\n${res.conflict_cs_ids.join(', ')}`,
							showCancel: false
						})
						return
					}

					ensureOk(res)
					uni.showToast({ title: 'æ’ç­æˆåŠŸ' })
					// é‡ç½®éƒ¨åˆ†çŠ¶æ€
					this.selectedCsIds = []
					this.selectedCsIdSet = {}
					this.setGridRangeByDate(this.scheduleDate)
					this.viewMode = 'grid'
					await this.reloadGrid()
				} catch (e) {
					uni.hideLoading()
					uni.showModal({
						title: 'æäº¤å¤±è´¥',
						content: e.errMsg || 'æœªçŸ¥é”™è¯¯',
						showCancel: false
					})
				}
			}
		}
	}
</script>

<style>
	.segmented-control {
		flex-direction: row;
		background-color: #f5f5f7;
		border-radius: 14px;
		padding: 4px;
	}

	.segment-item {
		flex: 1;
		height: 40px;
		align-items: center;
		justify-content: center;
		border-radius: 12px;
	}

	.segment-item.active {
		background-color: #ffffff;
		box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
	}

	.segment-text {
		color: #6e6e73;
		font-size: 14px;
		font-weight: 500;
	}

	.active-text {
		color: #1d1d1f;
	}

	.grid-toolbar {
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
	}

	.grid-toolbar-right {
		flex-direction: row;
		align-items: center;
	}

	.grid-toolbar-right button + button {
		margin-left: 10px;
	}

	.grid-range {
		font-size: 13px;
		color: #1d1d1f;
		font-weight: 500;
	}

	.apple-btn-small {
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: center;
		height: 36px;
		line-height: 36px;
		font-size: 14px;
		padding: 0 14px;
	}

	.grid-filter {
		flex: 1;
		margin-right: 12px;
	}

	.grid-scroll {
		width: 100%;
		margin-top: 14px;
	}

	.grid-table {
		min-width: 980px;
		background-color: #ffffff;
		border: 1px solid #e5e5e7;
		border-radius: 8px;
		overflow: hidden;
	}

	.grid-row {
		flex-direction: row;
	}

	.grid-row:nth-child(even) {
		background-color: #fafafa;
	}

	.grid-header {
		background-color: #f5f5f7;
		border-bottom: 2px solid #e5e5e7;
		padding-bottom: 0px;
		margin-bottom: 0px;
	}

	.grid-cell {
		width: 70px;
		height: 48px;
		justify-content: center;
		align-items: center;
		border-bottom: 1px solid #f0f0f2;
		border-right: 1px solid #f0f0f2;
	}

	.grid-sticky {
		width: 120px;
		align-items: flex-start;
		padding-left: 12px;
		padding-right: 12px;
		position: sticky;
		left: 0;
		z-index: 10;
		border-right: 2px solid #e5e5e7;
	}

	.grid-name {
		background-color: inherit;
	}
	
	.grid-header .grid-name {
		background-color: #f5f5f7;
	}

	.grid-date-text {
		font-size: 13px;
		color: #1d1d1f;
		font-weight: 600;
	}

	.grid-cs-name {
		font-size: 14px;
		font-weight: 600;
		color: #1d1d1f;
		width: 100%;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
	}

	.grid-cs-id {
		font-size: 11px;
		color: #86868b;
		margin-top: 1px;
	}

	.grid-slot {
		background-color: transparent;
	}
	
	.grid-slot:active {
		background-color: #f0f0f0;
	}

	/* æ™®é€šå·²æ’ç­èƒŒæ™¯ - æµ…è“è‰² */
	.grid-slot-filled {
		background-color: #edf6ff;
	}

	/* èŠ‚å‡æ—¥æ’ç­èƒŒæ™¯ - æµ…é»„è‰² */
	.grid-slot-holiday {
		background-color: #fff9e6;
	}

	/* äººå‘˜ä¸è¶³è­¦å‘ŠèƒŒæ™¯ - æµ…çº¢è‰²ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ */
	.grid-slot-warn {
		background-color: #ffebee;
	}

	.grid-slot-text {
		font-size: 14px;
		color: #1d1d1f;
		font-weight: 600;
	}

	.field {
		margin-bottom: 24px;
	}

	.picker-text {
		height: 50px;
		line-height: 22px;
		color: #1d1d1f;
	}

	.hint-text {
		font-size: 13px;
		color: #86868b;
		margin-top: 6px;
		margin-left: 4px;
	}

	.warn-text {
		font-size: 13px;
		color: #ff3b30;
		margin-top: 6px;
		margin-left: 4px;
		font-weight: 500;
	}
	
	.success-text {
		font-size: 13px;
		color: #34c759;
		margin-top: 6px;
		margin-left: 4px;
		font-weight: 500;
	}

	.filter-bar {
		margin-bottom: 16px;
	}

	.search-input {
		width: 100%;
	}

	.customer-list {
		border-top: 1px solid #f5f5f7;
	}

	.customer-item {
		border-bottom: 1px solid #f5f5f7;
	}
	
	.customer-item:last-child {
		border-bottom: none;
	}

	.customer-label {
		flex-direction: row;
		align-items: center;
		padding: 16px 0;
	}

	.checkbox-wrapper {
		margin-right: 16px;
	}

	.customer-info {
		flex: 1;
	}

	.customer-name {
		font-size: 17px;
		font-weight: 500;
		color: #1d1d1f;
		margin-bottom: 4px;
	}

	.customer-id {
		color: #86868b;
		font-size: 14px;
		margin-left: 4px;
	}

	.customer-skill {
		font-size: 13px;
		color: #86868b;
	}

	.empty-state {
		padding: 30px 0;
		align-items: center;
	}

	.empty-text {
		color: #86868b;
		font-size: 15px;
	}

	.action-bar {
		margin-top: 20px;
		margin-bottom: 40px;
	}

	/* å®¢æœåç§°å’Œåœ¨çº¿çŠ¶æ€åŒ…è£¹å™¨ */
	.grid-name-wrapper {
		flex-direction: row;
		align-items: center;
	}

	/* åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨ */
	.online-indicator {
		width: 10px;
		height: 10px;
		border-radius: 50%;
		margin-left: 6px;
		cursor: pointer;
		transition: transform 0.2s;
	}

	.online-indicator:active {
		transform: scale(1.2);
	}

	/* ğŸŸ¢åœ¨çº¿ - ç»¿è‰²å‘¼å¸åŠ¨ç”» */
	.online-indicator.status-online {
		background-color: #34c759;
		box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7);
		animation: pulse-animation 1.5s infinite;
	}

	/* ğŸŸ¡åœ¨çº¿éç­æ¬¡ - é»„è‰² */
	.online-indicator.status-online-off {
		background-color: #ffcc00;
		box-shadow: 0 0 4px rgba(255, 204, 0, 0.5);
	}

	/* ğŸ”´å¼‚å¸¸ç¦»çº¿ - çº¢è‰²é—ªçƒ */
	.online-indicator.status-abnormal {
		background-color: #ff3b30;
		box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7);
		animation: blink-animation 1s infinite;
	}

	/* âšªç¦»çº¿ - ç°è‰² */
	.online-indicator.status-offline {
		background-color: #c4c4c6;
	}

	/* å‘¼å¸è„‰å†²åŠ¨ç”»ï¼ˆç»¿è‰²åœ¨çº¿ï¼‰ */
	@keyframes pulse-animation {
		0% {
			transform: scale(0.95);
			box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7);
		}
		70% {
			transform: scale(1);
			box-shadow: 0 0 0 8px rgba(52, 199, 89, 0);
		}
		100% {
			transform: scale(0.95);
			box-shadow: 0 0 0 0 rgba(52, 199, 89, 0);
		}
	}

	/* é—ªçƒåŠ¨ç”»ï¼ˆçº¢è‰²å¼‚å¸¸ï¼‰ */
	@keyframes blink-animation {
		0%, 50%, 100% {
			opacity: 1;
		}
		25%, 75% {
			opacity: 0.3;
		}
	}
</style>
