<template>
	<view class="main-layout">
		<!-- å·¦ä¾§ä¾§è¾¹æ  -->
		<view class="sidebar">
			<view class="sidebar-header">
				<image class="logo" src="/static/PixPin_2026-01-13_19-52-32.png"></image>
				<text class="app-title">å®¢æœç³»ç»Ÿ</text>
			</view>
			
			<scroll-view class="menu-scroll" scroll-y="true">
				<!-- ç®¡ç†å‘˜èœå• -->
				<view v-if="isAdmin">
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'dashboard' }"
							@click="switchTab('dashboard')"
						>
							<text class="menu-icon">ğŸ“Š</text>
							<text class="menu-text">å·¥ä½œå°</text>
						</view>
					</view>

					<view class="menu-group-title">æ’ç­ç®¡ç†</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'schedule' }"
							@click="switchTab('schedule')"
						>
							<text class="menu-icon">ğŸ“…</text>
							<text class="menu-text">æ’ç­ç®¡ç†</text>
						</view>
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'shift' }"
							@click="switchTab('shift')"
						>
							<text class="menu-icon">âš™ï¸</text>
							<text class="menu-text">ç­æ¬¡é…ç½®</text>
						</view>
					</view>

					<view class="menu-group-title">å®¡æ‰¹ä¸­å¿ƒ</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'leave_approve' }"
							@click="switchTab('leave_approve')"
						>
							<text class="menu-icon">âœ…</text>
							<text class="menu-text">è¯·å‡å®¡æ‰¹</text>
						</view>
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'chain_swap_approve' }"
							@click="switchTab('chain_swap_approve')"
						>
							<text class="menu-icon">ğŸ”„</text>
							<text class="menu-text">è°ƒç­å®¡æ‰¹</text>
						</view>
					</view>

					<view class="menu-group-title">å®¢æˆ·æœåŠ¡</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'transfer' }"
							@click="switchTab('transfer')"
						>
							<text class="menu-icon">ğŸ’¬</text>
							<text class="menu-text">ä¼šè¯ç®¡ç†</text>
						</view>
					</view>
				</view>

				<!-- ç»ç†èœå• -->
				<view v-if="isManager">
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'schedule' }"
							@click="switchTab('schedule')"
						>
							<text class="menu-icon">ğŸ“…</text>
							<text class="menu-text">æ’ç­æ€»è§ˆ</text>
						</view>
					</view>

					<view class="menu-group-title">å®¡æ‰¹ä¸­å¿ƒ</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'leave_approve' }"
							@click="switchTab('leave_approve')"
						>
							<text class="menu-icon">âœ…</text>
							<text class="menu-text">è¯·å‡å®¡æ‰¹</text>
						</view>
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'chain_swap_approve' }"
							@click="switchTab('chain_swap_approve')"
						>
							<text class="menu-icon">ğŸ”„</text>
							<text class="menu-text">è°ƒç­å®¡æ‰¹</text>
						</view>
					</view>
				</view>

				<!-- å®¢æœèœå• -->
				<view v-if="isCS">
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'schedule' }"
							@click="switchTab('schedule')"
						>
							<text class="menu-icon">ğŸ“…</text>
							<text class="menu-text">æˆ‘çš„æ’ç­</text>
						</view>
					</view>

					<view class="menu-group-title">ç”³è¯·ç®¡ç†</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'leave_apply' }"
							@click="switchTab('leave_apply')"
						>
							<text class="menu-icon">âœˆï¸</text>
							<text class="menu-text">è¯·å‡ç”³è¯·</text>
						</view>
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'chain_swap_apply' }"
							@click="switchTab('chain_swap_apply')"
						>
							<text class="menu-icon">ğŸ”„</text>
							<text class="menu-text">è°ƒç­ç”³è¯·</text>
						</view>
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'my_applications' }"
							@click="switchTab('my_applications')"
						>
							<text class="menu-icon">ğŸ“</text>
							<text class="menu-text">æˆ‘çš„ç”³è¯·</text>
						</view>
					</view>

					<view class="menu-group-title">å®¢æˆ·æœåŠ¡</view>
					<view class="menu-group">
						<view 
							class="menu-item" 
							:class="{ active: currentTab === 'transfer' }"
							@click="switchTab('transfer')"
						>
							<text class="menu-icon">ğŸ’¬</text>
							<text class="menu-text">ä¼šè¯ç®¡ç†</text>
						</view>
					</view>
				</view>
			</scroll-view>
			
			<view class="sidebar-footer">
				<view class="user-info">
					<view class="avatar">{{ userAvatar }}</view>
					<view class="user-detail">
						<text class="username">{{ userName }}</text>
						<text class="role-name">{{ roleName }}</text>
					</view>
				</view>
				<view class="logout-btn" @click="handleLogout">
					<text class="logout-icon">ğŸšª</text>
					<text class="logout-text">é€€å‡º</text>
				</view>
			</view>
		</view>

		<!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
		<view class="content-area">
			<!-- é¡¶éƒ¨å¯¼èˆªæ  (å¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºå½“å‰è·¯å¾„æˆ–é¢åŒ…å±‘) -->
			<view class="top-bar">
				<text class="page-title">{{ currentPageTitle }}</text>
				<view class="top-actions">
					<text class="date-display">{{ currentDate }}</text>
				</view>
			</view>

			<!-- å†…å®¹è§†å›¾å®¹å™¨ -->
			<scroll-view class="view-scroll" scroll-y="true" :scroll-top="scrollTop" @scroll="onViewScroll">
				<view class="view-container">
					<DashboardView v-if="currentTab === 'dashboard'" @navigate="switchTab" />
					<ScheduleView v-if="currentTab === 'schedule'" />
					<ShiftConfigView v-if="currentTab === 'shift'" @request-scroll-top="scrollToTop" />
					<LeaveApplyView v-if="currentTab === 'leave_apply'" />
					<LeaveApproveView v-if="currentTab === 'leave_approve'" />
					<ChainSwapApplyView v-if="currentTab === 'chain_swap_apply'" />
					<ChainSwapApproveView v-if="currentTab === 'chain_swap_approve'" />
					<MyApplicationsView v-if="currentTab === 'my_applications'" />
					<TransferView v-if="currentTab === 'transfer'" />
				</view>
			</scroll-view>
		</view>
	</view>
</template>

<script>
	import DashboardView from '../../components/views/DashboardView.uvue'
	import ScheduleView from '../../components/views/ScheduleView.uvue'
	import ShiftConfigView from '../../components/views/ShiftConfigView.uvue'
	import LeaveApplyView from '../../components/views/LeaveApplyView.uvue'
	import LeaveApproveView from '../../components/views/LeaveApproveView.uvue'
	import ChainSwapApplyView from '../../components/views/ChainSwapApplyView.uvue'
	import ChainSwapApproveView from '../../components/views/ChainSwapApproveView.uvue'
	import MyApplicationsView from '../../components/views/MyApplicationsView.uvue'
	import TransferView from '../../components/views/TransferView.uvue'
	import { api } from '../../common/api.js'

	export default {
		components: {
			DashboardView,
			ScheduleView,
			ShiftConfigView,
			LeaveApplyView,
			LeaveApproveView,
			ChainSwapApplyView,
			ChainSwapApproveView,
			MyApplicationsView,
			TransferView
		},
		data() {
			return {
				currentTab: 'dashboard',
				currentDate: '',
				scrollTop: 0,
				lastScrollTop: 0,
				// ç”¨æˆ·ä¿¡æ¯
				userName: '',
				realName: '',
				roleCode: '',
				roleName: ''
			}
		},
		computed: {
			currentPageTitle() {
				const map = {
					'dashboard': 'å·¥ä½œå°',
					'schedule': 'æ’ç­ç®¡ç†',
					'shift': 'ç­æ¬¡é…ç½®',
					'leave_apply': 'è¯·å‡ç”³è¯·',
					'leave_approve': 'è¯·å‡å®¡æ‰¹',
					'chain_swap_apply': 'è°ƒç­ç”³è¯·',
					'chain_swap_approve': 'è°ƒç­å®¡æ‰¹',
					'my_applications': 'æˆ‘çš„ç”³è¯·',
					'transfer': 'ä¼šè¯ç®¡ç†'
				}
				return map[this.currentTab] || 'æœªçŸ¥é¡µé¢'
			},
			// ç”¨æˆ·å¤´åƒï¼ˆå–å§“åç¬¬ä¸€ä¸ªå­—ï¼‰
			userAvatar() {
				return this.realName ? this.realName.charAt(0) : 'U'
			},
			// æ˜¯å¦ä¸ºç®¡ç†å‘˜
			isAdmin() {
				return this.roleCode === 'admin'
			},
			// æ˜¯å¦ä¸ºç»ç†
			isManager() {
				return this.roleCode === 'manager'
			},
			// æ˜¯å¦ä¸ºå®¢æœ
			isCS() {
				return this.roleCode === 'cs' || (!this.isAdmin && !this.isManager)
			}
		},
		onLoad() {
			// æ£€æŸ¥ç™»å½•çŠ¶æ€
			const token = uni.getStorageSync('token')
			if (!token) {
				// æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
				uni.reLaunch({ url: '/pages/login/login' })
				return
			}

			// åŠ è½½ç”¨æˆ·ä¿¡æ¯
			try {
				const userInfoStr = uni.getStorageSync('userInfo')
				if (userInfoStr != null && userInfoStr != '') {
					let userInfo : UTSJSONObject | null = null
					if (typeof userInfoStr == 'string') {
						try {
							userInfo = JSON.parse(userInfoStr as string) as UTSJSONObject
						} catch (e) {
							console.error('JSONè§£æå¤±è´¥:', e)
						}
					} else {
						userInfo = userInfoStr as UTSJSONObject
					}

					if (userInfo != null) {
						this.userName = (userInfo['user_name'] ?? '') as string
						this.realName = (userInfo['real_name'] ?? '') as string
						this.roleCode = (userInfo['role_code'] ?? '') as string
						this.roleName = (userInfo['role_name'] ?? '') as string
					}
				}
			} catch (e) {
				console.error('è¯»å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e)
			}

			// è®¾ç½®å½“å‰æ—¥æœŸ
			const d = new Date()
			this.currentDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
			
			// æ ¹æ®è§’è‰²è®¾ç½®é»˜è®¤é¦–é¡µ
			if (this.isAdmin) {
				this.currentTab = 'dashboard'
			} else if (this.isManager) {
				this.currentTab = 'schedule'
			} else {
				// å®¢æœé»˜è®¤è¿›å…¥è¯·å‡ç”³è¯·é¡µé¢
				this.currentTab = 'leave_apply'
			}
		},
		methods: {
			// åˆ‡æ¢æ ‡ç­¾é¡µï¼ˆå¸¦æƒé™æ£€æŸ¥ï¼‰
			switchTab(tab) {
				// å®šä¹‰æ¯ä¸ªè§’è‰²å…è®¸è®¿é—®çš„é¡µé¢
				const rolePermissions = {
					'admin': ['dashboard', 'schedule', 'shift', 'leave_approve', 'chain_swap_approve', 'transfer'],
					'manager': ['schedule', 'leave_approve', 'chain_swap_approve'],
					'cs': ['schedule', 'leave_apply', 'chain_swap_apply', 'my_applications', 'transfer']
				}

				let allowedTabs = []
				if (this.isAdmin) {
					allowedTabs = rolePermissions.admin
				} else if (this.isManager) {
					allowedTabs = rolePermissions.manager
				} else {
					allowedTabs = rolePermissions.cs
				}

				if (!allowedTabs.includes(tab)) {
					uni.showToast({
						title: 'æ— æƒé™è®¿é—®è¯¥é¡µé¢',
						icon: 'none'
					})
					return
				}

				this.currentTab = tab
				this.scrollToTop()
			},
			scrollToTop() {
				// å…ˆè®¾ä¸ºä¸€ä¸ªæå°å€¼æˆ–ä¸åŒå€¼è§¦å‘å“åº”
				this.scrollTop = this.lastScrollTop
				this.$nextTick(() => {
					this.scrollTop = 0
				})
			},
			onViewScroll(e) {
				this.lastScrollTop = e.detail.scrollTop
			},
			// é€€å‡ºç™»å½•
			handleLogout() {
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							// è·å–å½“å‰ç”¨æˆ·IDå¹¶è°ƒç”¨logoutæ¥å£
							let csId = ''
							try {
								const userInfo = uni.getStorageSync('userInfo')
								if (userInfo) {
									const info = typeof userInfo === 'string' ? JSON.parse(userInfo) : userInfo
									csId = info.user_name || ''
								}
							} catch (e) {
								console.error('parse userInfo error:', e)
							}
							// è°ƒç”¨api.logoutï¼ˆä¼šè°ƒç”¨åç«¯æ¥å£å¹¶æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼‰
							api.logout(csId)
							// ä½¿ç”¨ reLaunch è·³è½¬åˆ°ç™»å½•é¡µï¼Œé¿å…é¡µé¢æ ˆé—®é¢˜
							uni.reLaunch({ url: '/pages/login/login' })
						}
					}
				})
			}
		}
	}
</script>

<style>
	.main-layout {
		flex-direction: row;
		width: 100%;
		height: 100vh;
		background-color: #f5f7fa;
		overflow: hidden; /* é˜²æ­¢æ•´ä½“æ»šåŠ¨ */
	}

	/* Sidebar Styles */
	.sidebar {
		width: 240px;
		background-color: #ffffff;
		border-right: 1px solid #ebedf0;
		flex-direction: column;
		display: flex;
	}

	.sidebar-header {
		height: 64px;
		flex-direction: row;
		align-items: center;
		padding: 0 20px;
		border-bottom: 1px solid #f5f5f7;
	}

	.logo {
		width: 32px;
		height: 32px;
		margin-right: 10px;
	}

	.app-title {
		font-size: 18px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.menu-scroll {
		flex: 1;
		padding: 16px 0;
	}

	.menu-group-title {
		padding: 0 24px;
		margin-top: 16px;
		margin-bottom: 8px;
		font-size: 12px;
		color: #86909c;
		font-weight: 500;
	}

	.menu-item {
		flex-direction: row;
		align-items: center;
		height: 48px;
		padding: 0 20px;
		margin: 0 12px;
		border-radius: 8px;
		cursor: pointer; /* PC style */
	}

	.menu-item:hover {
		background-color: #f7f8fa;
	}

	.menu-item.active {
		background-color: #e8f3ff;
	}

	.menu-item.active .menu-text {
		color: #007aff;
		font-weight: 500;
	}

	.menu-icon {
		font-size: 18px;
		margin-right: 12px;
	}

	.menu-text {
		font-size: 14px;
		color: #4e5969;
	}

	.sidebar-footer {
		height: 64px;
		border-top: 1px solid #f5f5f7;
		padding: 0 20px;
		justify-content: center;
	}

	.user-info {
		flex-direction: row;
		align-items: center;
	}

	.avatar {
		width: 32px;
		height: 32px;
		border-radius: 16px;
		background-color: #007aff;
		justify-content: center;
		align-items: center;
		color: #fff;
		font-size: 14px;
		font-weight: 600;
		margin-right: 10px;
	}

	.username {
		font-size: 14px;
		color: #1d1d1f;
		font-weight: 500;
	}

	/* Content Area Styles */
	.content-area {
		flex: 1;
		flex-direction: column;
		display: flex;
		height: 100vh;
	}

	.top-bar {
		height: 64px;
		background-color: #ffffff;
		border-bottom: 1px solid #ebedf0;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		padding: 0 32px;
	}

	.page-title {
		font-size: 18px;
		font-weight: 600;
		color: #1d1d1f;
	}

	.date-display {
		font-size: 14px;
		color: #86909c;
	}

	.view-scroll {
		flex: 1;
		/* background-color: #f5f7fa; already set on main-layout but good to ensure */
	}

	.view-container {
		padding: 24px 32px;
		min-height: 100%;
	}

	/* ç”¨æˆ·è¯¦æƒ…æ ·å¼ */
	.user-detail {
		flex-direction: column;
		flex: 1;
	}

	.role-name {
		font-size: 12px;
		color: #86909c;
		margin-top: 2px;
	}

	/* é€€å‡ºç™»å½•æŒ‰é’®æ ·å¼ */
	.logout-btn {
		flex-direction: row;
		align-items: center;
		padding: 6px 12px;
		border-radius: 6px;
		cursor: pointer;
		margin-left: auto;
	}

	.logout-btn:hover {
		background-color: #fff1f0;
	}

	.logout-icon {
		font-size: 14px;
		margin-right: 4px;
	}

	.logout-text {
		font-size: 12px;
		color: #f5222d;
	}
</style>

