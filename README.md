# å®¢æœæ’ç­ä¼šè¯ç®¡ç†ç³»ç»Ÿ (Piaowu)

> åŸºäº Go å¾®æœåŠ¡æ¶æ„çš„ä¼ä¸šçº§å®¢æœç®¡ç†å¹³å°ï¼Œæä¾›æ™ºèƒ½æ’ç­è°ƒåº¦ã€å®æ—¶ä¼šè¯æ¥å¾…ã€æ•°æ®ç»Ÿè®¡åˆ†æç­‰æ ¸å¿ƒèƒ½åŠ›

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬ç³»ç»Ÿæ˜¯é¢å‘å®¢æœä¸­å¿ƒçš„ä¸€ä½“åŒ–ç®¡ç†å¹³å°ï¼Œé‡‡ç”¨ **Gateway + RPC** å¾®æœåŠ¡æ¶æ„ï¼Œè§£å†³å®¢æœå›¢é˜Ÿæ—¥å¸¸è¿è¥ä¸­çš„ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ï¼š

| ä¸šåŠ¡ç—›ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|---------|---------|
| **æ’ç­è°ƒåº¦å¤æ‚** | æ™ºèƒ½æ’ç­å¼•æ“ + å†²çªæ£€æµ‹ + äººæ•°é¢„è­¦ |
| **ä¼šè¯å“åº”æ•ˆç‡ä½** | WebSocket å®æ—¶é€šä¿¡ + ä¼šè¯è½¬æ¥ + å¿«æ·å›å¤ |
| **æ•°æ®åˆ†æå›°éš¾** | å¤šç»´ç»Ÿè®¡çœ‹æ¿ + Excel å¯¼å‡º + ä¼šè¯åˆ†ç±»æ ‡ç­¾ |

---

## ğŸ¢ ä¸šåŠ¡æ¶æ„

### æ ¸å¿ƒä¸šåŠ¡åŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æœæ’ç­ä¼šè¯ç®¡ç†ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ğŸ“… æ’ç­ç®¡ç†      â”‚   ğŸ’¬ ä¼šè¯ç®¡ç†      â”‚   ğŸ“Š æ•°æ®ç®¡ç†            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç­æ¬¡é…ç½®        â”‚ â€¢ å®æ—¶ä¼šè¯æ¥å¾…    â”‚ â€¢ ä¼šè¯åˆ†ç±»æ ‡ç­¾           â”‚
â”‚ â€¢ æ’ç­åˆ†é…        â”‚ â€¢ ä¼šè¯è½¬æ¥        â”‚ â€¢ ç»Ÿè®¡åˆ†æçœ‹æ¿           â”‚
â”‚ â€¢ è¯·å‡è°ƒç­å®¡æ‰¹    â”‚ â€¢ å¿«æ·å›å¤é…ç½®    â”‚ â€¢ æ•°æ®æ£€ç´¢å¯¼å‡º           â”‚
â”‚ â€¢ è‡ªåŠ¨æ’ç­        â”‚ â€¢ æ¶ˆæ¯å†å²        â”‚ â€¢ æ ¸å¿ƒä¼šè¯æ ‡è®°           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸šåŠ¡æµç¨‹

#### 1. æ’ç­ç®¡ç†æµç¨‹

```mermaid
graph LR
    A[åˆ›å»ºç­æ¬¡é…ç½®] --> B[åˆ†é…æ’ç­]
    B --> C{å†²çªæ£€æµ‹}
    C -- æœ‰å†²çª --> D[è¿”å›å†²çªåˆ—è¡¨]
    C -- æ— å†²çª --> E[æ’ç­ç”Ÿæ•ˆ]
    E --> F[å®¢æœè¯·å‡/è°ƒç­]
    F --> G[ç®¡ç†å‘˜å®¡æ‰¹]
    G -- é€šè¿‡ --> H[è‡ªåŠ¨æ›´æ–°æ’ç­è¡¨]
    G -- æ‹’ç» --> I[æµç¨‹ç»“æŸ]
```

**å…³é”®èƒ½åŠ›ï¼š**
- **ç­æ¬¡é…ç½®**ï¼šæ”¯æŒæ—©ç­/ä¸­ç­/æ™šç­/å¤œç­è‡ªå®šä¹‰ï¼Œé…ç½®æ—¶é—´èŒƒå›´å’Œæœ€å°åœ¨å²—äººæ•°
- **å†²çªæ£€æµ‹**ï¼šåŒä¸€å®¢æœåŒä¸€å¤©ä¸å¯åˆ†é…å¤šä¸ªç­æ¬¡ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹¦æˆª
- **å®¡æ‰¹è”åŠ¨**ï¼šè¯·å‡/è°ƒç­å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨ä¿®æ­£æ’ç­è®°å½•å’Œå®¢æœçŠ¶æ€

#### 2. ä¼šè¯ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant WS as WebSocket Hub
    participant CS as å®¢æœ
    participant RPC as å®¢æœRPCæœåŠ¡
    
    User->>WS: å‘èµ·å’¨è¯¢(WebSocket)
    WS->>RPC: è·¯ç”±åˆ†é…
    RPC-->>CS: æ¨é€æ–°ä¼šè¯
    
    loop å®æ—¶æ²Ÿé€š
        User->>WS: å‘é€æ¶ˆæ¯
        WS->>CS: æ¨é€æ¶ˆæ¯
        CS->>WS: å›å¤æ¶ˆæ¯
        WS->>User: æ¨é€å›å¤
    end
    
    opt ä¼šè¯è½¬æ¥
        CS->>RPC: å‘èµ·è½¬æ¥
        RPC->>RPC: ç”Ÿæˆä¸Šä¸‹æ–‡æ‘˜è¦
        RPC-->>CS: ç§»äº¤ä¼šè¯
    end
    
    CS->>RPC: ç»“æŸä¼šè¯
    RPC->>RPC: å½’æ¡£æ¶ˆæ¯è®°å½•
```

**å…³é”®èƒ½åŠ›ï¼š**
- **å®æ—¶é€šä¿¡**ï¼šåŸºäº WebSocket çš„åŒå‘å®æ—¶æ¶ˆæ¯æ¨é€
- **æ™ºèƒ½è½¬æ¥**ï¼šè½¬æ¥æ—¶è‡ªåŠ¨æºå¸¦æœ€è¿‘10æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡æ‘˜è¦
- **å¿«æ·å›å¤**ï¼šæŒ‰åˆ†ç±»é…ç½®å¸¸ç”¨è¯æœ¯ï¼Œæå‡å›å¤æ•ˆç‡

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  APP/å°ç¨‹åº   â”‚  â”‚   Web ç®¡ç†å°  â”‚  â”‚    H5 é¡µé¢    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP REST       â”‚ HTTP REST       â”‚ WebSocket
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway (8081)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ JWT è®¤è¯     â”‚  â”‚ CORS ä¸­é—´ä»¶  â”‚  â”‚ TraceID æ³¨å…¥ â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    WebSocket Hub                             â”‚  â”‚
â”‚  â”‚  â€¢ è¿æ¥ç®¡ç†   â€¢ æ¶ˆæ¯è·¯ç”±   â€¢ åœ¨çº¿çŠ¶æ€ç»Ÿè®¡                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ Kitex RPC (Thriftåè®®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Customer RPC Service (8888)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ä¸šåŠ¡é€»è¾‘å±‚                                 â”‚  â”‚
â”‚  â”‚  â€¢ æ’ç­ç®¡ç†   â€¢ ä¼šè¯ç®¡ç†   â€¢ å¿«æ·å›å¤   â€¢ æ•°æ®ç»Ÿè®¡   â€¢ ç”¨æˆ·è®¤è¯ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    æ•°æ®è®¿é—®å±‚ (DAL)                          â”‚  â”‚
â”‚  â”‚  â€¢ GORM ORM   â€¢ Redis ç¼“å­˜   â€¢ é“¾è·¯è¿½è¸ªæ’ä»¶                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å­˜å‚¨å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚       MySQL         â”‚  â”‚        Redis        â”‚                 â”‚
â”‚  â”‚  â€¢ ä¸šåŠ¡æ•°æ®æŒä¹…åŒ–     â”‚  â”‚  â€¢ çƒ­ç‚¹æ•°æ®ç¼“å­˜      â”‚                 â”‚
â”‚  â”‚  â€¢ äº‹åŠ¡ä¿è¯          â”‚  â”‚  â€¢ ä¼šè¯çŠ¶æ€å­˜å‚¨      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **ç¼–ç¨‹è¯­è¨€** | Go | 1.25.5 | åç«¯æœåŠ¡å¼€å‘ |
| **RPCæ¡†æ¶** | Kitex | v0.15.4 | å­—èŠ‚è·³åŠ¨é«˜æ€§èƒ½RPCæ¡†æ¶ |
| **åºåˆ—åŒ–åè®®** | Thrift | - | IDLå®šä¹‰ä¸ä»£ç ç”Ÿæˆ |
| **ORMæ¡†æ¶** | GORM | v1.31.1 | æ•°æ®åº“å¯¹è±¡æ˜ å°„ |
| **æ•°æ®åº“** | MySQL | 8.0+ | æ ¸å¿ƒä¸šåŠ¡æ•°æ®å­˜å‚¨ |
| **ç¼“å­˜** | Redis | 6.0+ | çƒ­ç‚¹æ•°æ®ç¼“å­˜ |
| **å®æ—¶é€šä¿¡** | WebSocket | gorilla/websocket v1.5.3 | åŒå‘å®æ—¶æ¶ˆæ¯ |
| **èº«ä»½è®¤è¯** | JWT | golang-jwt v5.3.0 | Tokenè®¤è¯ |
| **é…ç½®ç®¡ç†** | Viper | v1.21.0 | å¤šæ ¼å¼é…ç½®è§£æ |
| **æ—¥å¿—æ¡†æ¶** | Zap | v1.27.0 | ç»“æ„åŒ–æ—¥å¿— |
| **Excelå¤„ç†** | Excelize | v2.10.0 | æ•°æ®å¯¼å…¥å¯¼å‡º |
| **å‰ç«¯æ¡†æ¶** | Uni-app + Vue 3 | - | è·¨ç«¯å‰ç«¯åº”ç”¨ |

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼

#### 1. Gateway + RPC åˆ†å±‚æ¶æ„

```
èŒè´£åˆ†ç¦»ï¼š
â”œâ”€â”€ Gateway (ç½‘å…³å±‚)
â”‚   â”œâ”€â”€ HTTP/WebSocket åè®®å¤„ç†
â”‚   â”œâ”€â”€ è¯·æ±‚å‚æ•°æ ¡éªŒä¸è½¬æ¢
â”‚   â”œâ”€â”€ JWT èº«ä»½è®¤è¯
â”‚   â”œâ”€â”€ è·¨åŸŸå¤„ç† (CORS)
â”‚   â””â”€â”€ è¯·æ±‚è·¯ç”±ä¸é™æµ
â”‚
â””â”€â”€ RPC Service (æœåŠ¡å±‚)
    â”œâ”€â”€ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°
    â”œâ”€â”€ æ•°æ®åº“äº‹åŠ¡ç®¡ç†
    â”œâ”€â”€ ç¼“å­˜ç­–ç•¥æ§åˆ¶
    â””â”€â”€ ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
```

#### 2. ç¼“å­˜è®¾è®¡ç­–ç•¥

| ç¼“å­˜é”® | æ•°æ®ç±»å‹ | TTL | å¤±æ•ˆç­–ç•¥ |
|--------|---------|-----|---------|
| `customer:shift_config:all:v1` | æ‰€æœ‰ç­æ¬¡é…ç½® | 30åˆ†é’Ÿ | æ›´æ–°/åˆ é™¤æ—¶ä¸»åŠ¨æ¸…é™¤ |
| `customer:conv_category:all:v1` | æ‰€æœ‰ä¼šè¯åˆ†ç±» | 30åˆ†é’Ÿ | æ›´æ–°æ—¶ä¸»åŠ¨æ¸…é™¤ |
| `customer:conv_tag:all:v1` | æ‰€æœ‰ä¼šè¯æ ‡ç­¾ | 60åˆ†é’Ÿ | å˜æ›´æ—¶ä¸»åŠ¨æ¸…é™¤ |
| `customer:quick_reply:list:*` | å¿«æ·å›å¤åˆ—è¡¨ | 5åˆ†é’Ÿ | è‡ªç„¶è¿‡æœŸ |

#### 3. é“¾è·¯è¿½è¸ª

- **TraceID ç”Ÿæˆ**ï¼šGateway ä¸­é—´ä»¶ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ TraceID
- **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šé€šè¿‡ `context.Context` åœ¨æœåŠ¡é—´ä¼ é€’
- **GORM æ’ä»¶**ï¼šè‡ªåŠ¨å°† TraceID æ³¨å…¥ SQL æ‰§è¡Œæ—¥å¿—
- **æ—¥å¿—å…³è”**ï¼šæ‰€æœ‰æ—¥å¿—å‡æºå¸¦ TraceIDï¼Œæ”¯æŒå…¨é“¾è·¯é—®é¢˜å®šä½

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
piaowu/
â”œâ”€â”€ gateway/                          # API ç½‘å…³æœåŠ¡
â”‚   â”œâ”€â”€ config/                       # ç½‘å…³é…ç½®
â”‚   â”‚   â””â”€â”€ config.yaml               # Gateway æœåŠ¡é…ç½®
â”‚   â”œâ”€â”€ handler/                      # HTTP è¯·æ±‚å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ customer_handler.go       # å®¢æœä¸šåŠ¡ HTTP å¤„ç† (1600+ è¡Œ)
â”‚   â”œâ”€â”€ middleware/                   # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.go                   # JWT è®¤è¯
â”‚   â”‚   â”œâ”€â”€ cors.go                   # è·¨åŸŸå¤„ç†
â”‚   â”‚   â””â”€â”€ trace.go                  # TraceID æ³¨å…¥
â”‚   â”œâ”€â”€ router/                       # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ router.go                 # è·¯ç”±æ³¨å†Œ (30+ æ¥å£)
â”‚   â”œâ”€â”€ rpc/                          # RPC å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â””â”€â”€ customer_client.go        # Customer æœåŠ¡å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ws/                           # WebSocket æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ hub.go                    # è¿æ¥ç®¡ç†ä¸æ¶ˆæ¯åˆ†å‘
â”‚   â”‚   â””â”€â”€ client.go                 # WebSocket å®¢æˆ·ç«¯
â”‚   â””â”€â”€ main.go                       # ç½‘å…³å…¥å£
â”‚
â”œâ”€â”€ service/customer/                 # å®¢æœ RPC æœåŠ¡
â”‚   â”œâ”€â”€ config/                       # æœåŠ¡é…ç½®
â”‚   â”‚   â””â”€â”€ config.yaml               # MySQL/Redis é…ç½®
â”‚   â”œâ”€â”€ dal/                          # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ db.go                     # GORM æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ redis.go                  # Redis å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â””â”€â”€ plugin/trace.go           # GORM é“¾è·¯è¿½è¸ªæ’ä»¶
â”‚   â”œâ”€â”€ handler/                      # RPC æœåŠ¡å®ç°
â”‚   â”‚   â””â”€â”€ handler.go                # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (2300+ è¡Œ)
â”‚   â”œâ”€â”€ model/                        # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ model.go                  # ä¸šåŠ¡è¡¨æ¨¡å‹ (9 å¼ è¡¨)
â”‚   â”‚   â””â”€â”€ auth.go                   # ç”¨æˆ·è®¤è¯æ¨¡å‹
â”‚   â”œâ”€â”€ idl/                          # Thrift IDL å®šä¹‰
â”‚   â”‚   â””â”€â”€ customer.thrift           # æœåŠ¡æ¥å£å®šä¹‰ (538 è¡Œ)
â”‚   â”œâ”€â”€ kitex_gen/                    # Kitex ç”Ÿæˆä»£ç 
â”‚   â””â”€â”€ main.go                       # RPC æœåŠ¡å…¥å£
â”‚
â”œâ”€â”€ web/                              # å‰ç«¯åº”ç”¨ (Uni-app)
â”‚   â”œâ”€â”€ pages/                        # é¡µé¢ç›®å½•
â”‚   â”‚   â”œâ”€â”€ login/                    # ç™»å½•é¡µ
â”‚   â”‚   â”œâ”€â”€ register/                 # æ³¨å†Œé¡µ
â”‚   â”‚   â”œâ”€â”€ index/                    # ä¸»é¡µ
â”‚   â”‚   â”œâ”€â”€ schedule/                 # æ’ç­ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ shift/                    # ç­æ¬¡é…ç½®
â”‚   â”‚   â”œâ”€â”€ leave/                    # è¯·å‡è°ƒç­
â”‚   â”‚   â””â”€â”€ conversation/             # ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ components/                   # å…¬å…±ç»„ä»¶
â”‚
â”œâ”€â”€ pkg/                              # å…¬å…±å·¥å…·åŒ…
â”‚   â””â”€â”€ logger/                       # æ—¥å¿—å·¥å…·
â”‚
â”œâ”€â”€ scripts/                          # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ run_gateway_new.bat           # Windows å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ migrate_new.go                # æ•°æ®è¿ç§»å·¥å…·
â”‚
â”œâ”€â”€ go.mod                            # Go æ¨¡å—ä¾èµ–
â””â”€â”€ README.md                         # é¡¹ç›®æ–‡æ¡£
```

---

## ğŸ’¾ æ•°æ®æ¨¡å‹

### ER å…³ç³»å›¾

```mermaid
erDiagram
    t_customer_service ||--o{ t_schedule : "è¢«æ’ç­"
    t_shift_config ||--o{ t_schedule : "ç­æ¬¡"
    t_customer_service ||--o{ t_leave_transfer : "ç”³è¯·"
    t_customer_service ||--o{ t_conversation : "æ¥å¾…"
    t_conversation ||--o{ t_conv_message : "æ¶ˆæ¯"
    t_conv_category ||--o{ t_conversation : "åˆ†ç±»"
    t_quick_reply }|--|| t_customer_service : "åˆ›å»º"
    
    t_customer_service {
        varchar cs_id PK "å®¢æœID"
        varchar cs_name "å®¢æœå§“å"
        varchar dept_id "éƒ¨é—¨ID"
        varchar skill_tags "æŠ€èƒ½æ ‡ç­¾"
        tinyint status "åœ¨èŒçŠ¶æ€"
        tinyint current_status "æ’ç­çŠ¶æ€"
    }
    
    t_shift_config {
        bigint shift_id PK "ç­æ¬¡ID"
        varchar shift_name "ç­æ¬¡åç§°"
        time start_time "å¼€å§‹æ—¶é—´"
        time end_time "ç»“æŸæ—¶é—´"
        int min_staff "æœ€å°äººæ•°"
        tinyint is_holiday "èŠ‚å‡æ—¥"
    }
    
    t_schedule {
        bigint schedule_id PK "æ’ç­ID"
        varchar cs_id FK "å®¢æœID"
        bigint shift_id FK "ç­æ¬¡ID"
        date schedule_date "æ’ç­æ—¥æœŸ"
        tinyint status "çŠ¶æ€"
    }
    
    t_conversation {
        varchar conv_id PK "ä¼šè¯ID"
        varchar user_id "ç”¨æˆ·ID"
        varchar cs_id FK "å®¢æœID"
        bigint category_id "åˆ†ç±»ID"
        tinyint status "ä¼šè¯çŠ¶æ€"
    }
    
    t_conv_message {
        bigint msg_id PK "æ¶ˆæ¯ID"
        varchar conv_id FK "ä¼šè¯ID"
        tinyint sender_type "å‘é€æ–¹ç±»å‹"
        text msg_content "æ¶ˆæ¯å†…å®¹"
    }
```

### æ ¸å¿ƒæ•°æ®è¡¨

| è¡¨å | è¯´æ˜ | å…³é”®ç´¢å¼• |
|------|------|---------|
| `t_shift_config` | ç­æ¬¡é…ç½®è¡¨ | `(shift_name, is_holiday)` |
| `t_customer_service` | å®¢æœä¿¡æ¯è¡¨ | `(cs_id, dept_id)` |
| `t_schedule` | æ’ç­è®°å½•è¡¨ | `(cs_id, schedule_date)`, `(schedule_date, shift_id)` |
| `t_leave_transfer` | è¯·å‡è°ƒç­ç”³è¯·è¡¨ | `(cs_id, approval_status)` |
| `t_conversation` | ä¼šè¯è¡¨ | `(user_id, start_time)`, `(cs_id, start_time)` |
| `t_conv_message` | ä¼šè¯æ¶ˆæ¯è¡¨ | `(conv_id, send_time)` |
| `t_quick_reply` | å¿«æ·å›å¤è¡¨ | `(reply_type, is_public)` |
| `t_conv_category` | ä¼šè¯åˆ†ç±»è¡¨ | `UNIQUE(category_name)` |
| `t_conv_tag` | ä¼šè¯æ ‡ç­¾è¡¨ | `UNIQUE(tag_name)` |

---

## ğŸ”Œ API æ¥å£

### æ¥å£åˆ†ç±»

#### è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/v1/user/login` | ç”¨æˆ·ç™»å½• |
| POST | `/api/v1/user/register` | ç”¨æˆ·æ³¨å†Œ |
| GET | `/api/v1/user/current` | è·å–å½“å‰ç”¨æˆ· |

#### å®¢æœç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/customer/get` | è·å–å®¢æœä¿¡æ¯ |
| GET | `/api/customer/list` | å®¢æœåˆ—è¡¨æŸ¥è¯¢ |

#### ç­æ¬¡é…ç½®

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/shift/create` | åˆ›å»ºç­æ¬¡ |
| GET | `/api/shift/list` | ç­æ¬¡åˆ—è¡¨ |
| POST | `/api/shift/update` | æ›´æ–°ç­æ¬¡ |
| POST | `/api/shift/delete` | åˆ é™¤ç­æ¬¡ |

#### æ’ç­ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/schedule/assign` | åˆ†é…æ’ç­ |
| POST | `/api/schedule/auto` | è‡ªåŠ¨æ’ç­ |
| GET | `/api/schedule/grid` | æ’ç­è¡¨æ ¼æ•°æ® |
| POST | `/api/schedule/cell/upsert` | æ›´æ–°æ’ç­å•å…ƒæ ¼ |
| GET | `/api/schedule/export` | å¯¼å‡º Excel |

#### è¯·å‡è°ƒç­

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/leave/apply` | æäº¤ç”³è¯· |
| POST | `/api/leave/approve` | å®¡æ‰¹ç”³è¯· |
| GET | `/api/leave/get` | è·å–ç”³è¯·è¯¦æƒ… |
| GET | `/api/leave/list` | ç”³è¯·åˆ—è¡¨ |

#### ä¼šè¯ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/conversation/list` | ä¼šè¯åˆ—è¡¨ |
| GET | `/api/conversation/history/list` | å†å²ä¼šè¯ |
| POST | `/api/conversation/transfer` | ä¼šè¯è½¬æ¥ |
| GET | `/api/conversation/message/list` | æ¶ˆæ¯åˆ—è¡¨ |
| POST | `/api/conversation/message/send` | å‘é€æ¶ˆæ¯ |
| GET | `/api/conversation/stats` | ç»Ÿè®¡æ•°æ® |

#### WebSocket

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `/ws?token=xxx` | WebSocket è¿æ¥ç«¯ç‚¹ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Go**: 1.25.5+
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **Node.js**: 16+ (å‰ç«¯å¼€å‘å¯é€‰)

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd piaowu
```

### 2. å®‰è£…ä¾èµ–

```bash
go mod download
```

### 3. é…ç½®æ•°æ®åº“

åˆ›å»ºæ•°æ®åº“ï¼š

```sql
CREATE DATABASE piaowu_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

ç¼–è¾‘ `service/customer/config/config.yaml`ï¼š

```yaml
mysql:
  host: 127.0.0.1
  port: 3306
  user: root
  password: your_password
  database: piaowu_db

redis:
  host: 127.0.0.1
  port: 6379
  password: ""
  db: 0
```

### 4. æ•°æ®è¿ç§»

```bash
go run scripts/migrate_new.go
```

### 5. å¯åŠ¨æœåŠ¡

**å¯åŠ¨ RPC æœåŠ¡ï¼š**

```bash
cd service/customer
go run main.go
# è¾“å‡º: Customer service started at 0.0.0.0:8888
```

**å¯åŠ¨ Gatewayï¼š**

```bash
cd gateway
go run main.go
# è¾“å‡º: Gateway started at 0.0.0.0:8081
```

### 6. éªŒè¯æœåŠ¡

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8081/health
# è¿”å›: OK
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### Gateway é…ç½®

`gateway/config/config.yaml`ï¼š

```yaml
server:
  address: 0.0.0.0:8081          # Gateway ç›‘å¬åœ°å€

services:
  customer:
    name: customer-service       # RPC æœåŠ¡åç§°
    address: 127.0.0.1:8888      # RPC æœåŠ¡åœ°å€

jwt:
  secret: piaowu-secret-key      # JWT ç­¾åå¯†é’¥
  expire_hours: 24               # Token è¿‡æœŸæ—¶é—´
```

### RPC æœåŠ¡é…ç½®

`service/customer/config/config.yaml`ï¼š

```yaml
server:
  name: customer-service
  address: 0.0.0.0:8888

mysql:
  host: 127.0.0.1
  port: 3306
  user: root
  password: your_password
  database: piaowu_db
  max_idle_conns: 10
  max_open_conns: 100

redis:
  host: 127.0.0.1
  port: 6379
  password: ""
  db: 0
```

---

## âœ¨ æŠ€æœ¯äº®ç‚¹

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **å¾®æœåŠ¡æ¶æ„** | Gateway + RPC åˆ†å±‚ï¼ŒèŒè´£æ¸…æ™°ï¼Œæ”¯æŒæ°´å¹³æ‰©å±• |
| **é«˜æ€§èƒ½ RPC** | Kitex æ¡†æ¶ï¼ŒThrift åè®®ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯ |
| **åˆ†å±‚ç¼“å­˜** | Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œé™ä½æ•°æ®åº“å‹åŠ› |
| **å®æ—¶é€šä¿¡** | WebSocket Hub æ¨¡å¼ï¼Œæ”¯æŒå¹¿æ’­å’Œç‚¹å¯¹ç‚¹æ¶ˆæ¯ |
| **å…¨é“¾è·¯è¿½è¸ª** | TraceID è´¯ç©¿è¯·æ±‚å…¨ç”Ÿå‘½å‘¨æœŸï¼Œé—®é¢˜å¿«é€Ÿå®šä½ |
| **äº‹åŠ¡ä¸€è‡´æ€§** | å…³é”®æ“ä½œï¼ˆå®¡æ‰¹ã€è½¬æ¥ï¼‰ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´ |
| **æ•°æ®å®‰å…¨** | bcrypt å¯†ç åŠ å¯†ï¼ŒJWT Token è®¤è¯ |
| **æ•°æ®å¯¼å‡º** | Excelize æ”¯æŒ Excel æ ¼å¼å¯¼å‡º |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼€å‘æ–‡æ¡£](./å¼€å‘æ–‡æ¡£.md)
- [æ•°æ®è¡¨è®¾è®¡](./æ•°æ®è¡¨è®¾è®¡.md)
- [æ•°æ®æ¥å£è®¾è®¡](./æ•°æ®æ¥å£è®¾è®¡.md)
- [å‰ç«¯å¼€å‘è¦ç‚¹](./å‰ç«¯å¼€å‘è¦ç‚¹.md)
- [åç«¯å¼€å‘è¦ç‚¹](./åç«¯å¼€å‘è¦ç‚¹.md)
- [ä¼˜åŒ–æ–¹æ¡ˆ](./ä¼˜åŒ–æ–¹æ¡ˆ.md)

---

## ğŸ‘¥ è´¡çŒ®è€…

å¼ æµ©å®‡ - é¡¹ç›®è´Ÿè´£äºº

---

## ğŸ“œ License

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚
