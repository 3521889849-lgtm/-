✅《Go 微服务项目结构重构 · AI 执行总指令》

你现在是我的 Go 微服务项目重构助手，请对现有项目进行结构与分层重构，而不是重写业务功能。
重构目标是实现：清晰分层、职责单一、方便扩展 AI / 智能客服能力。

🎯 一、总体架构原则（必须遵守）

Gateway 只负责：HTTP / WS 接入 + RPC 调用，禁止任何业务逻辑

所有业务逻辑必须集中在 service 层

所有数据库访问必须通过 repository 层

handler 层只允许做：参数校验 + 调用 service

service 层禁止直接写 GORM/SQL

repository 层禁止出现业务判断

NLP / LLM / RAG 相关能力统一抽到 pkg/ai

crypto / logger / trace 属于 pkg 公共能力

禁止跨模块直接调用 repository

所有修改必须保持项目可编译

🗂 二、目标目录结构规范
gateway
gateway/
├─ router
├─ handler        # 仅参数校验 + RPC调用
├─ rpc            # RPC client 封装
├─ middleware
├─ ws
├─ config
└─ main.go

service/customer
service/customer/
├─ cmd
├─ config
├─ idl
├─ kitex_gen

├─ handler        # RPC 接口入口
├─ service        # ⭐业务逻辑核心
├─ repository     # 原 dal，负责 DB
├─ model

├─ domain         # 状态枚举 / 领域对象（可选）
└─ main.go

pkg 公共能力
pkg/
├─ logger
├─ trace
├─ crypto
└─ ai             # NLP / RAG / LLM 调用统一入口

🔧 三、重构执行顺序（必须按阶段来）
✅ 阶段一：目录调整（不改业务）

目标：只移动文件与修正 import，保证可运行

操作：

dal → repository

新建 service 目录

handler / model 保持不变

nlp、crypto 从 customer 移到 pkg

✅ 阶段二：抽离业务逻辑到 service 层

目标：handler 变薄

规则：

handler 中禁止出现：

if / for / switch

状态判断

多步骤流程

所有业务流程迁移到：

service/*.go

handler 示例：

func (h *Handler) Reply(ctx, req) {
return customerService.Reply(ctx, req)
}

✅ 阶段三：统一数据访问

目标：service 不直接操作 DB

规则：

禁止：

db.Where(...).Find(...)


必须改为：

repo.GetByID(...)


repository 层：

只允许 CRUD

不允许业务含义判断

✅ 阶段四：抽离 AI / NLP 能力

目标：为智能客服与智能体铺路

操作：

原 service/customer/nlp → pkg/ai

通过接口在 service 层调用

例如：

ai.ExtractIntent(text)
ai.MatchKnowledge(query)

🧭 四、模块改造方式

重构必须按模块逐个推进：

顺序建议：

customer 核心会话流程

排班相关逻辑

请假 / 调班

AI 自动回复与分类

每完成一个模块必须：

能编译

能通过已有接口调用

⚠️ 五、禁止行为

❌ 不允许新增功能

❌ 不允许合并多个模块

❌ 不允许一次性全项目大改

❌ 不允许在 gateway 写业务

❌ 不允许 service 直接连 DB

✅ 六、输出要求

每一阶段修改前必须先输出：

本阶段涉及哪些目录

迁移哪些文件

handler / service / repository 职责说明

再给具体修改代码。

❤️ 最后给你一句真心话（也可以丢给 AI 看）

本项目已经包含完整业务与微服务形态，当前重构目标是工程能力升级，而不是功能实现，请以“可维护性、可扩展性、可测试性”为第一优先级。