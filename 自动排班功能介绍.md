# 自动排班功能介绍

本文档旨在介绍客服排班会话管理系统中的“自动排班”功能，包括其功能概述、核心逻辑、使用方法及技术实现。

## 1. 功能概述

自动排班功能旨在通过算法自动为客服人员分配班次，从而减轻管理员的手工排班负担，提高排班效率。系统根据预设的班次配置和客服人员列表，在指定的日期范围内，智能地进行排班填充。

**主要特点：**
- **智能填充**：自动识别未排班的空缺，仅对未排班的客服进行分配，不覆盖已有排班。
- **轮询均衡**：采用轮询算法，尽量保证客服人员在不同班次间的分配相对均衡。
- **灵活筛选**：支持按部门、小组筛选客服进行自动排班（目前后端已支持，前端默认对当前视图所有客服生效）。
- **安全限制**：限制单次自动排班最大跨度为 31 天，防止误操作导致大规模数据错误。

## 2. 核心逻辑与规则

### 2.1 参与对象
- **客服人员**：状态为“正常”（status=1）的客服人员。
- **班次配置**：系统中所有有效的班次配置。

### 2.2 排班规则
1. **日期遍历**：系统会遍历用户选择的起始日期（StartDate）到结束日期（EndDate）。
2. **跳过已有排班**：
   - 在每一天，系统首先查询当天已经存在排班记录的客服。
   - **关键规则**：自动排班**不会**修改或覆盖这些已有记录，仅为当天**尚未排班**的客服分配班次。
3. **轮询分配算法**：
   - 系统维护一个全局的客服指针和班次列表。
   - 对于每一天未排班的客服，依次分配当前班次列表中的下一个班次。
   - 算法简化示意：`SelectedShift = Shifts[ GlobalIndex % ShiftCount ]`
   - 这种方式确保了在连续多天的时间段内，客服人员会被轮流分配到不同的班次（例如：早班 -> 中班 -> 晚班 -> 早班...），避免长期固定在单一班次。

### 2.3 限制条件
- **时间跨度**：`EndDate - StartDate` 不能超过 31 天。
- **数据完整性**：操作在一个数据库事务中完成，确保要么全部成功，要么全部回滚。

## 3. 使用方法

### 3.1 前端入口
- **页面**：排班管理页面（`ScheduleView`）。
- **视图**：需切换至**“表格”**视图模式。
- **位置**：表格右上角工具栏，位于“导出Excel”按钮左侧。

### 3.2 操作步骤
1. **选择范围**：在表格视图中，通过“上一周/下一周”按钮调整当前显示的日期范围（默认为 2 周）。
2. **点击按钮**：点击**“自动排班”**按钮。
3. **确认操作**：系统弹出确认对话框，提示排班日期范围及“系统将自动为未排班的客服分配班次”。
4. **等待完成**：点击“确定”后，系统后台进行计算与存储。
5. **查看结果**：操作成功后，表格会自动刷新，显示新生成的排班数据。

## 4. 接口定义 (API)

- **路径**：`/api/schedule/auto`
- **方法**：`POST`
- **请求参数 (JSON)**：
  ```json
  {
    "start_date": "2026-01-01",  // 必填，开始日期 (YYYY-MM-DD)
    "end_date": "2026-01-14",    // 必填，结束日期 (YYYY-MM-DD)
    "dept_id": "",               // 选填，部门ID筛选
    "team_id": "",               // 选填，小组ID筛选
    "operator_id": "ADMIN"       // 操作人ID
  }
  ```
- **响应参数 (JSON)**：
  ```json
  {
    "code": 0,
    "msg": "success",
    "data": {
       "total_scheduled": 56 // 本次新增的排班条数
    }
  }
  ```

## 5. 常见问题 (FAQ)

**Q: 自动排班会把我已经排好的班次覆盖掉吗？**
A: 不会。系统会先检查当天已有的排班记录，只对没有排班的客服进行操作。

**Q: 为什么有的时候排班看起来不是完全均匀的？**
A: 如果部分客服已经预先手动排了班，或者请假了，轮询算法会跳过他们，这可能会导致在局部范围内某些班次的人数看起来多一点或少一点，但长期来看是趋于轮动的。

**Q: 我能一次排一整年的班吗？**
A: 不能。为了系统性能和防止误操作，单次操作限制最大跨度为 31 天。如需排全年，请分月操作。
