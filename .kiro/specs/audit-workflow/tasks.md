# 审核流程管理系统实现计划

## 概述

基于现有的天极票务系统架构，实现完整的审核流程管理功能。系统将扩展现有的Kitex RPC服务和Hertz API服务，添加审核流程配置、自动审核引擎、人工审核处理、流程控制、进度查询和历史记录等核心功能。

## 任务

- [x] 1. 扩展IDL定义和数据模型
  - 在现有coupon.thrift中添加审核流程相关的结构体和服务定义
  - 创建审核流程相关的数据模型和数据库表结构
  - 设置数据库迁移和索引优化
  - _需求: 1.1, 1.2, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 1.1 为IDL扩展编写属性测试
  - **属性2: 自定义流程配置支持**
  - **验证需求: Requirements 1.1, 1.2, 1.4**

- [ ] 2. 实现状态机引擎核心组件
  - [ ] 2.1 创建审核状态机结构和状态转换逻辑
    - 实现AuditStateMachine结构体和状态转换方法
    - 定义审核状态和事件枚举
    - 实现状态转换验证和执行逻辑
    - _需求: 4.1, 4.2, 4.3_

  - [ ] 2.2 为状态机编写属性测试
    - **属性4: 审核流程状态转换**
    - **验证需求: Requirements 2.3, 2.5, 4.1, 4.2**

  - [ ] 2.3 实现状态处理器接口
    - 为每个审核状态创建对应的处理器
    - 实现状态进入和退出的业务逻辑
    - 添加状态转换的日志记录
    - _需求: 4.4, 4.5_

- [ ] 3. 实现审核流程配置服务
  - [ ] 3.1 创建审核配置RPC服务
    - 实现CreateAuditConfig、UpdateAuditConfig等RPC方法
    - 添加配置验证和权限检查逻辑
    - 实现配置变更历史记录功能
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ] 3.2 为配置服务编写属性测试
    - **属性1: 审核配置管理一致性**
    - **验证需求: Requirements 1.3, 1.5**

  - [ ] 3.3 创建配置管理API接口
    - 在api/router.go中添加审核配置相关路由
    - 实现HTTP到RPC的请求转换和响应处理
    - 添加API参数验证和错误处理
    - _需求: 1.1, 1.2_

- [ ] 4. 检查点 - 确保配置和状态机测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. 实现自动审核引擎
  - [ ] 5.1 创建规则引擎组件
    - 实现审核规则的解析和执行逻辑
    - 创建资质文件校验的核心算法
    - 添加规则配置的动态加载功能
    - _需求: 2.1, 2.2_

  - [ ] 5.2 为自动审核编写属性测试
    - **属性3: 自动审核规则执行**
    - **验证需求: Requirements 2.1, 2.2, 2.4**

  - [ ] 5.3 实现自动审核RPC服务
    - 创建TriggerAutoAudit、ValidateQualification等方法
    - 集成规则引擎和状态机进行审核处理
    - 添加审核结果的详细记录和通知
    - _需求: 2.3, 2.4, 2.5_

  - [ ] 5.4 创建自动审核API接口
    - 添加自动审核触发和结果查询的HTTP接口
    - 实现文件上传和审核状态的实时反馈
    - _需求: 2.1, 2.2_

- [ ] 6. 实现人工审核处理服务
  - [ ] 6.1 创建人工审核RPC服务
    - 实现SubmitAuditResult、GetPendingAudits等方法
    - 添加审核任务分配和权限控制逻辑
    - 实现审核意见和驳回理由的记录功能
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ] 6.2 为人工审核编写属性测试
    - **属性5: 人工审核操作完整性**
    - **验证需求: Requirements 3.1, 3.2, 3.3, 3.4, 3.5**

  - [ ] 6.3 创建人工审核API接口
    - 添加审核员工作台相关的HTTP接口
    - 实现审核任务列表和详情查看功能
    - 添加审核操作的前端交互支持
    - _需求: 3.1, 3.2_

- [ ] 7. 实现审核流程控制器
  - [ ] 7.1 创建流程控制RPC服务
    - 实现TransferAuditFlow、RetriggerAudit等方法
    - 集成状态机进行流程自动化控制
    - 添加流程异常处理和恢复机制
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ] 7.2 为流程控制编写属性测试
    - **属性6: 流程异常处理和恢复**
    - **验证需求: Requirements 4.3, 4.4, 4.5**

  - [ ] 7.3 创建流程控制API接口
    - 添加流程管理相关的HTTP接口
    - 实现流程状态查询和手动干预功能
    - _需求: 4.1, 4.2_

- [ ] 8. 检查点 - 确保核心审核功能测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 9. 实现审核进度查询服务
  - [ ] 9.1 创建进度查询RPC服务
    - 实现QueryAuditProgress、BatchQueryProgress等方法
    - 添加实时进度计算和预估时间功能
    - 实现权限控制和数据筛选逻辑
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [ ] 9.2 为进度查询编写属性测试
    - **属性7: 审核进度实时性**
    - **验证需求: Requirements 5.1, 5.2, 5.3, 5.5**

  - [ ] 9.3 为批量查询编写属性测试
    - **属性8: 批量查询和筛选功能**
    - **验证需求: Requirements 5.4**

  - [ ] 9.4 创建进度查询API接口
    - 添加进度查询相关的HTTP接口
    - 实现进度展示和实时更新功能
    - _需求: 5.1, 5.4_

- [ ] 10. 实现审核历史记录服务
  - [ ] 10.1 创建历史记录RPC服务
    - 实现QueryAuditHistory、ExportAuditRecords等方法
    - 添加操作日志的完整记录和查询功能
    - 实现数据导出和归档处理逻辑
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [ ] 10.2 为历史记录编写属性测试
    - **属性9: 审核历史记录完整性**
    - **验证需求: Requirements 6.1, 6.2, 6.3**

  - [ ] 10.3 为数据导出编写属性测试
    - **属性10: 数据导出和归档功能**
    - **验证需求: Requirements 6.4, 6.5**

  - [ ] 10.4 创建历史记录API接口
    - 添加历史查询和导出相关的HTTP接口
    - 实现操作日志的展示和对比功能
    - _需求: 6.2, 6.4_

- [ ] 11. 集成和系统测试
  - [ ] 11.1 更新现有服务集成
    - 修改现有的商家入驻流程以集成审核功能
    - 更新数据库初始化和迁移脚本
    - 添加配置文件和环境变量支持
    - _需求: 所有需求_

  - [ ] 11.2 编写集成测试
    - 测试完整的审核流程端到端功能
    - 验证与现有系统的兼容性
    - _需求: 所有需求_

  - [ ] 11.3 更新API文档和示例
    - 更新Postman集合和API使用示例
    - 添加审核流程的使用指南
    - _需求: 所有需求_

- [ ] 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况